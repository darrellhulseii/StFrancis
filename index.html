<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>The Life of Saint Francis of Assisi</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; background: #000; }

  #gameCanvas {
    display: block;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }

  #ui {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 10;
    font-family: 'Segoe UI', sans-serif;
  }

  /* N64-style pixelated font feel */
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=MedievalSharp&display=swap');

  #titleScreen {
    position: fixed; inset: 0; z-index: 100;
    background: radial-gradient(ellipse at center, #1a0a2e 0%, #0a0010 60%, #000 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: 'Georgia', serif;
    pointer-events: all;
    overflow: hidden;
  }

  .title-stars {
    position: absolute; inset: 0;
    background-image: radial-gradient(1px 1px at 20% 30%, #fff 100%, transparent),
      radial-gradient(1px 1px at 80% 10%, #fff 100%, transparent),
      radial-gradient(1px 1px at 50% 70%, #fff 100%, transparent),
      radial-gradient(1px 1px at 10% 80%, #fff 100%, transparent),
      radial-gradient(1px 1px at 90% 60%, #fff 100%, transparent),
      radial-gradient(1px 1px at 35% 15%, #fff 100%, transparent),
      radial-gradient(1px 1px at 65% 85%, #fff 100%, transparent),
      radial-gradient(1px 1px at 15% 50%, #fff 100%, transparent),
      radial-gradient(1px 1px at 75% 40%, #fff 100%, transparent),
      radial-gradient(1px 1px at 45% 25%, #fff 100%, transparent),
      radial-gradient(2px 2px at 55% 55%, #ffd700 100%, transparent),
      radial-gradient(2px 2px at 25% 75%, #ffd700 100%, transparent);
  }

  .title-cross {
    font-size: clamp(60px, 12vw, 120px);
    color: #ffd700;
    text-shadow: 0 0 30px #ffd700, 0 0 60px #ff8c00, 0 0 90px #ffd700;
    animation: glowPulse 2s ease-in-out infinite;
    margin-bottom: 10px;
  }
  @keyframes glowPulse {
    0%,100% { text-shadow: 0 0 30px #ffd700, 0 0 60px #ff8c00; }
    50% { text-shadow: 0 0 50px #ffd700, 0 0 100px #ff8c00, 0 0 140px #ffd700; }
  }

  .title-main {
    font-size: clamp(20px, 5vw, 52px);
    color: #ffd700;
    text-align: center;
    letter-spacing: 6px;
    text-transform: uppercase;
    font-weight: bold;
    text-shadow: 3px 3px 0 #8B6914, 6px 6px 10px rgba(0,0,0,0.8);
    animation: titleFadeIn 1.5s ease-out forwards;
    line-height: 1.2;
  }
  @keyframes titleFadeIn {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .title-sub {
    font-size: clamp(10px, 2.5vw, 22px);
    color: #d4af37;
    letter-spacing: 3px;
    margin-top: 8px;
    opacity: 0;
    animation: titleFadeIn 1.5s ease-out 0.5s forwards;
  }

  .title-bio {
    max-width: min(700px, 90vw);
    margin: 20px auto 0;
    padding: 20px 24px;
    background: rgba(0,0,0,0.7);
    border: 2px solid #8B6914;
    border-radius: 4px;
    color: #e8d5a0;
    font-style: italic;
    font-size: clamp(10px, 2vw, 15px);
    line-height: 1.7;
    text-align: center;
    opacity: 0;
    animation: titleFadeIn 1.5s ease-out 1s forwards;
  }

  .title-quote-attr {
    color: #ffd700; font-style: normal; font-size: 0.85em; margin-top: 6px;
  }

  .start-btn {
    margin-top: 24px;
    padding: 14px 48px;
    background: linear-gradient(135deg, #8B6914, #ffd700, #8B6914);
    border: 3px solid #ffd700;
    color: #1a0a2e;
    font-size: clamp(12px, 2.5vw, 18px);
    font-weight: bold;
    letter-spacing: 4px;
    text-transform: uppercase;
    cursor: pointer;
    font-family: Georgia, serif;
    border-radius: 4px;
    pointer-events: all;
    animation: titleFadeIn 1s ease-out 1.5s forwards, btnPulse 1.5s ease-in-out 2s infinite;
    opacity: 0;
    transition: transform 0.1s;
    box-shadow: 0 0 20px rgba(255,215,0,0.4);
  }
  @keyframes btnPulse {
    0%,100% { box-shadow: 0 0 20px rgba(255,215,0,0.4); }
    50% { box-shadow: 0 0 40px rgba(255,215,0,0.9); }
  }
  .start-btn:hover { transform: scale(1.05); }
  .start-btn:active { transform: scale(0.97); }

  /* HUD elements */
  #stageBanner {
    position: fixed; top: 0; left: 0; right: 0;
    text-align: center;
    padding: 10px 20px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
    color: #ffd700;
    font-family: Georgia, serif;
    font-size: clamp(11px, 2.5vw, 18px);
    letter-spacing: 3px;
    display: none;
    pointer-events: none;
    z-index: 20;
    text-transform: uppercase;
    text-shadow: 2px 2px 4px #000;
  }

  #dialogueBox {
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
    width: min(800px, 92vw);
    background: rgba(10,5,25,0.95);
    border: 3px solid #8B6914;
    border-radius: 6px;
    padding: 16px 20px;
    color: #e8d5a0;
    font-family: Georgia, serif;
    font-size: clamp(10px, 2vw, 15px);
    line-height: 1.7;
    display: none;
    z-index: 30;
    pointer-events: none;
    box-shadow: 0 0 30px rgba(139,105,20,0.5), inset 0 0 20px rgba(0,0,0,0.5);
  }
  #dialogueBox .speaker {
    color: #ffd700; font-weight: bold; font-size: 1.1em;
    margin-bottom: 6px; letter-spacing: 2px;
    font-style: normal;
  }
  #dialogueBox .text { font-style: italic; }
  #dialogueBox .attribution {
    color: #d4af37; font-size: 0.82em; margin-top: 8px;
    font-style: normal; text-align: right;
  }
  #dialogueBox .continue-hint {
    color: #888; font-size: 0.78em; margin-top: 6px; text-align: center;
    animation: blinkAnim 1s ease-in-out infinite;
  }
  @keyframes blinkAnim { 0%,100%{opacity:1} 50%{opacity:0.3} }

  #interactPrompt {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    border: 2px solid #ffd700;
    border-radius: 4px;
    padding: 10px 20px;
    color: #ffd700;
    font-family: Georgia, serif;
    font-size: clamp(11px, 2.5vw, 16px);
    display: none;
    z-index: 25;
    pointer-events: none;
    text-align: center;
    animation: blinkAnim 1s ease-in-out infinite;
  }

  #objectiveBar {
    position: fixed; top: 14px; left: 14px;
    background: rgba(0,0,0,0.75);
    border: 2px solid #8B6914;
    border-radius: 4px;
    padding: 8px 14px;
    color: #ffd700;
    font-family: Georgia, serif;
    font-size: clamp(9px, 1.8vw, 13px);
    display: none;
    z-index: 20;
    pointer-events: none;
    max-width: min(280px, 40vw);
  }
  #objectiveBar .obj-title { color: #d4af37; font-size: 0.85em; letter-spacing: 2px; text-transform: uppercase; }
  #objectiveBar .obj-text { color: #e8d5a0; margin-top: 4px; }

  #stageProgress {
    position: fixed; top: 14px; right: 14px;
    background: rgba(0,0,0,0.75);
    border: 2px solid #8B6914;
    border-radius: 4px;
    padding: 8px 14px;
    color: #ffd700;
    font-family: Georgia, serif;
    font-size: clamp(9px, 1.8vw, 13px);
    display: none;
    z-index: 20;
    pointer-events: none;
    text-align: right;
  }

  /* Touch D-pad */
  #dpad {
    position: fixed; bottom: 20px; left: 20px;
    width: 120px; height: 120px;
    display: none;
    z-index: 40;
    pointer-events: all;
    user-select: none;
    -webkit-user-select: none;
  }
  #dpad .dpad-grid {
    display: grid;
    grid-template-columns: repeat(3, 40px);
    grid-template-rows: repeat(3, 40px);
    gap: 0;
  }
  .dpad-btn {
    background: rgba(0,0,0,0.6);
    border: 2px solid rgba(255,215,0,0.5);
    color: #ffd700;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    border-radius: 2px;
    transition: background 0.1s;
  }
  .dpad-btn:active, .dpad-btn.pressed { background: rgba(139,105,20,0.6); }
  .dpad-center { background: rgba(0,0,0,0.3) !important; border: none !important; }

  #actionBtns {
    position: fixed; bottom: 20px; right: 20px;
    display: none;
    z-index: 40;
    pointer-events: all;
    gap: 10px;
    flex-direction: column;
    align-items: flex-end;
  }
  .action-btn {
    width: 56px; height: 56px;
    border-radius: 50%;
    border: 3px solid rgba(255,215,0,0.7);
    background: rgba(0,0,0,0.65);
    color: #ffd700;
    font-size: 13px;
    font-weight: bold;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    user-select: none;
    font-family: Georgia, serif;
    letter-spacing: 0.5px;
  }
  .action-btn:active { background: rgba(139,105,20,0.7); transform: scale(0.93); }

  /* Cutscene overlay */
  #cutscene {
    position: fixed; inset: 0; z-index: 80;
    background: #000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: all;
  }
  #cutscene .cut-art {
    font-size: clamp(80px, 20vw, 180px);
    text-align: center;
    margin-bottom: 20px;
  }
  #cutscene .cut-title {
    font-family: Georgia, serif;
    font-size: clamp(16px, 4vw, 36px);
    color: #ffd700;
    letter-spacing: 4px;
    text-transform: uppercase;
    text-align: center;
    margin-bottom: 16px;
    text-shadow: 0 0 20px #ffd700;
  }
  #cutscene .cut-text {
    max-width: min(700px, 88vw);
    font-family: Georgia, serif;
    font-size: clamp(11px, 2.2vw, 16px);
    color: #e8d5a0;
    line-height: 1.8;
    font-style: italic;
    text-align: center;
    padding: 16px 20px;
    background: rgba(0,0,0,0.6);
    border: 1px solid #8B6914;
    border-radius: 4px;
    margin: 0 16px;
  }
  #cutscene .cut-attr {
    color: #d4af37; font-style: normal; font-size: 0.85em;
    margin-top: 8px; display: block;
  }
  #cutscene .cut-continue {
    margin-top: 20px;
    color: #ffd700;
    font-family: Georgia, serif;
    font-size: clamp(11px, 2vw, 15px);
    animation: blinkAnim 1s ease-in-out infinite;
    letter-spacing: 2px;
    cursor: pointer;
    padding: 10px 30px;
    border: 2px solid #8B6914;
    border-radius: 4px;
    background: rgba(0,0,0,0.5);
  }

  #particleOverlay {
    position: fixed; inset: 0; pointer-events: none;
    z-index: 5; overflow: hidden;
  }

  .particle {
    position: absolute;
    border-radius: 50%;
    animation: floatUp linear infinite;
    pointer-events: none;
  }
  @keyframes floatUp {
    from { transform: translateY(0) rotate(0deg); opacity: 1; }
    to { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
  }

  #miraceEffect {
    position: fixed; inset: 0; z-index: 50;
    background: radial-gradient(ellipse at center, rgba(255,215,0,0.9) 0%, rgba(255,140,0,0.5) 40%, transparent 70%);
    display: none;
    pointer-events: none;
    animation: miraclePulse 0.5s ease-out;
  }
  @keyframes miraclePulse {
    0% { opacity: 0; transform: scale(0.5); }
    50% { opacity: 1; transform: scale(1.2); }
    100% { opacity: 0; transform: scale(1.5); }
  }

  #loading {
    position: fixed; inset: 0; z-index: 200;
    background: #000;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    font-family: Georgia, serif;
    color: #ffd700;
    font-size: clamp(14px, 3vw, 22px);
    letter-spacing: 3px;
  }
  #loadingBar {
    width: min(300px, 80vw); height: 8px;
    background: #1a0a2e;
    border: 2px solid #8B6914;
    border-radius: 4px;
    margin-top: 20px;
    overflow: hidden;
  }
  #loadingFill {
    height: 100%;
    background: linear-gradient(to right, #8B6914, #ffd700);
    width: 0%;
    transition: width 0.3s;
    border-radius: 2px;
  }

  #finalScreen {
    position: fixed; inset: 0; z-index: 90;
    background: radial-gradient(ellipse at center, #fff5cc 0%, #ffd700 30%, #ff8c00 60%, #1a0a2e 100%);
    display: none; flex-direction: column; align-items: center; justify-content: center;
    font-family: Georgia, serif;
    pointer-events: all;
    padding: 20px;
  }
  #finalScreen .final-title {
    font-size: clamp(24px, 6vw, 56px);
    color: #1a0a2e; font-weight: bold;
    letter-spacing: 4px;
    text-shadow: 2px 2px 0 rgba(255,255,255,0.5);
    text-align: center;
    animation: titleFadeIn 2s ease-out;
  }
  #finalScreen .final-quote {
    max-width: min(680px, 90vw);
    font-size: clamp(12px, 2.5vw, 18px);
    color: #1a0a2e;
    font-style: italic;
    line-height: 1.8;
    text-align: center;
    margin: 24px 0;
    padding: 20px;
    background: rgba(255,255,255,0.4);
    border-radius: 8px;
    animation: titleFadeIn 2s ease-out 0.5s backwards;
  }
  #finalScreen .restart-btn {
    padding: 12px 40px;
    background: #1a0a2e;
    color: #ffd700;
    border: 3px solid #ffd700;
    font-size: clamp(12px, 2.5vw, 18px);
    font-family: Georgia, serif;
    letter-spacing: 3px;
    cursor: pointer;
    border-radius: 4px;
    text-transform: uppercase;
    animation: titleFadeIn 2s ease-out 1s backwards;
  }
  #finalScreen .restart-btn:hover { background: #ffd700; color: #1a0a2e; }
</style>
</head>
<body>

<div id="loading">
  <div>‚úù LOADING ‚úù</div>
  <div id="loadingBar"><div id="loadingFill"></div></div>
</div>

<div id="titleScreen" style="display:none;">
  <div class="title-stars"></div>
  <div class="title-cross">‚úù</div>
  <div class="title-main">The Life of<br>Saint Francis<br>of Assisi</div>
  <div class="title-sub">Il Poverello ¬∑ 1181 ‚Äì 1226</div>
  <div class="title-bio">
    "Francis was not yet perfect in virtue, but he was drawing near to that perfection of the humble life which he was afterwards to lead. His heart was being stirred by the Holy Ghost, and though he knew it not, he was being prepared by the grace of God for that great work to which he had been called."
    <div class="title-quote-attr">‚Äî Thomas of Celano, <em>Vita Prima Sancti Francisci</em>, c. 1228</div>
  </div>
  <button class="start-btn" onclick="startGame()">Begin the Journey ‚úù</button>
</div>

<canvas id="gameCanvas"></canvas>

<div id="ui">
  <div id="stageBanner"></div>
  <div id="objectiveBar">
    <div class="obj-title">Objective</div>
    <div class="obj-text" id="objText"></div>
  </div>
  <div id="stageProgress" id="stageProgress"></div>
  <div id="dialogueBox">
    <div class="speaker" id="dlgSpeaker"></div>
    <div class="text" id="dlgText"></div>
    <div class="attribution" id="dlgAttr"></div>
    <div class="continue-hint">‚ñº Tap or press SPACE / ENTER to continue</div>
  </div>
  <div id="interactPrompt"></div>
</div>

<div id="dpad">
  <div class="dpad-grid">
    <div class="dpad-btn" id="dUL" data-dir="ul">‚Üñ</div>
    <div class="dpad-btn" id="dU" data-dir="u">‚ñ≤</div>
    <div class="dpad-btn" id="dUR" data-dir="ur">‚Üó</div>
    <div class="dpad-btn" id="dL" data-dir="l">‚óÑ</div>
    <div class="dpad-btn dpad-center"></div>
    <div class="dpad-btn" id="dR" data-dir="r">‚ñ∫</div>
    <div class="dpad-btn" id="dDL" data-dir="dl">‚Üô</div>
    <div class="dpad-btn" id="dD" data-dir="d">‚ñº</div>
    <div class="dpad-btn" id="dDR" data-dir="dr">‚Üò</div>
  </div>
</div>

<div id="actionBtns" style="display:flex;">
  <div class="action-btn" id="btnInteract" onclick="handleInteract()">‚úù<br><span style="font-size:9px">ACT</span></div>
  <div class="action-btn" onclick="handleDialogueContinue()" style="width:48px;height:48px;">‚ñ∂</div>
</div>

<div id="cutscene">
  <div class="cut-art" id="cutArt"></div>
  <div class="cut-title" id="cutTitle"></div>
  <div class="cut-text" id="cutText"></div>
  <div class="cut-continue" onclick="cutsceneContinue()">[ Tap or Press Any Key to Continue ]</div>
</div>

<div id="miraceEffect"></div>

<div id="finalScreen" style="display:none; flex-direction:column;">
  <div class="final-title">‚úù Pax et Bonum ‚úù<br>Peace and All Good</div>
  <div class="final-quote">
    "Praised be You, my Lord, through Sister Bodily Death, from whom no one living can escape. Woe to those who die in mortal sin! Blessed are those whom death will find in Your most holy will, for the second death will do them no harm."
    <br><em style="font-size:0.85em;">‚Äî St. Francis of Assisi, Canticle of the Sun, 1225</em>
    <br><br>
    Francis of Assisi departed this world on the evening of October 3, 1226, singing Psalm 141 as he lay on the bare earth. He was canonized just two years later, on July 16, 1228, by Pope Gregory IX. His example of poverty, humility, and love for all creation continues to inspire millions across the world.
  </div>
  <button class="restart-btn" onclick="location.reload()">‚úù Play Again ‚úù</button>
</div>

<div id="particleOverlay"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';

// ‚îÄ‚îÄ‚îÄ GLOBAL STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const G = {
  scene: null, camera: null, renderer: null, clock: null,
  player: null, playerMesh: null, playerDir: new THREE.Vector3(0,0,-1),
  moveInput: { x:0, z:0 },
  keys: {},
  stage: 'title',
  stageIndex: 0,
  dialogueQueue: [],
  dialogueActive: false,
  interactable: null,
  interactables: [],
  animId: null,
  particles3D: [],
  churchPieces: [],
  fixedPieces: 0,
  totalPieces: 5,
  birds: [],
  wolfMesh: null,
  wolfTamed: false,
  miraclesDone: 0,
  birdsPeached: false,
  stigmataReceived: false,
  frameCount: 0,
  fps: 144,
  lastFrame: 0,
  targetMs: 1000/144,
  skyColor: 0x87CEEB,
  fogColor: 0x87CEEB,
  groundColor: 0x228B22,
};

// ‚îÄ‚îÄ‚îÄ DIALOGUE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DIALOGUES = {
  assisi_welcome: [
    { speaker:"Narrator", text:"Assisi, Umbria ‚Äî circa 1201 AD. Giovanni di Pietro di Bernardone, known as Francis, was the son of a prosperous cloth merchant. He lived a life of revelry and song, the most celebrated youth in the city.", attr:"Thomas of Celano, Vita Prima, 1228" },
    { speaker:"Narrator", text:"\"He was so extravagant in his expenses that he seemed not a merchant's son but a great prince. He was eager for pleasure, full of jests and song, going about the streets of Assisi by day and night, reveling with his companions.\"", attr:"Thomas of Celano, Vita Prima Sancti Francisci, Ch. I" },
    { speaker:"Francis", text:"Friends! Life is sweet and the night is young! Eat, drink, and sing ‚Äî for tomorrow God only knows what He has planned for us!", attr:"" },
    { speaker:"Narrator", text:"But in his heart, a restlessness grew. After a battle with Perugia and a year as a prisoner of war, Francis returned to Assisi changed ‚Äî hollow and ill. Something was stirring within him.", attr:"" },
  ],
  voice_of_god: [
    { speaker:"Narrator", text:"One day, near the ruined chapel of San Damiano, Francis knelt before a painted crucifix. Then, a voice ‚Äî clear and unmistakable ‚Äî broke the silence.", attr:"" },
    { speaker:"The Voice of Christ", text:"\"Francis... Francis... go and repair My house, which, as you see, is falling completely to ruin.\"", attr:"Three Companions, Legenda Trium Sociorum, c. 1241" },
    { speaker:"Francis", text:"Lord... I trembled in my whole body! I did not know at first if You spoke of this little church, or something greater still. I will obey!", attr:"Francis himself, in Thomas of Celano, Vita Prima" },
    { speaker:"Narrator", text:"Francis at first took the command literally. He sold cloth from his father's shop to raise money and began the physical repair of the chapel of San Damiano.", attr:"" },
  ],
  repair_intro: [
    { speaker:"Objective", text:"The chapel of San Damiano lies in ruins. God has called Francis to repair it. Walk to each broken section of the church and press ‚úù ACT to mend it with prayer and labor.", attr:"" },
    { speaker:"Brother Stone Mason", text:"No man can mend these walls alone. But I have seen stranger things than stone obeying the will of a saint.", attr:"" },
  ],
  repair_piece: [
    { speaker:"Francis", text:"\"Lord, make me an instrument of Your peace. Where there is hatred, let me sow love; where there is injury, pardon.\"", attr:"Prayer attributed to St. Francis of Assisi" },
  ],
  repair_complete: [
    { speaker:"Narrator", text:"\"With his own hands he repaired three churches: San Damiano, San Pietro della Spina, and the Portiuncula. When he had fully restored them, he felt the Spirit of God driving him onward to a still greater work.\"", attr:"Thomas of Celano, Vita Prima, Ch. XXI" },
    { speaker:"Francis", text:"The Lord has spoken to me about poverty, humility, and the holy Gospel. That is all I wish, with all my heart!", attr:"St. Francis, as recorded by Thomas of Celano" },
  ],
  birds_intro: [
    { speaker:"Narrator", text:"Near Bevagna, Francis and his companions walked along the road when Francis noticed a great flock of birds of all kinds gathered in the trees and fields nearby.", attr:"" },
    { speaker:"Francis", text:"Brothers, wait here for me while I go preach to our sisters the birds!", attr:"Thomas of Celano, Vita Prima, Ch. LVIII" },
    { speaker:"Objective", text:"Walk to the flock of birds gathered on the hillside. Press ‚úù ACT to preach to them.", attr:"" },
  ],
  birds_miracle: [
    { speaker:"Narrator", text:"Francis went to the birds, and when he began to preach, they did not fly away. They stretched their necks, spread their wings, and opened their beaks, gazing upon him with great attention.", attr:"" },
    { speaker:"Francis", text:"\"My sisters the birds, you owe much to God your Creator, and you ought to sing His praise at all times and in all places, because He has given you liberty to fly about into all places. He has also given you a double and triple clothing. Moreover He preserved your seed in Noah's ark.\"", attr:"Thomas of Celano, Vita Prima Sancti Francisci, Ch. LVIII, c. 1228" },
    { speaker:"Francis", text:"\"You sow not, neither do you reap; and God feedeth you, and giveth you the streams and fountains for your drink; the mountains and valleys for your refuge and the high trees whereon to make your nests. And although you neither spin nor weave, God dresseth you and your children, wherefore your Creator loveth you much.\"", attr:"The Little Flowers of St. Francis, Chapter XVI, 14th c." },
    { speaker:"Narrator", text:"\"The birds all manifested very great joy... they began to open their beaks, to stretch their necks, to spread their wings, and reverently to bow their heads to the ground, showing by their motions and songs that the holy father had given them great delight.\"", attr:"The Little Flowers of St. Francis, Ch. XVI" },
  ],
  wolf_intro: [
    { speaker:"Narrator", text:"Near the city of Gubbio, a fierce wolf terrorized the people ‚Äî devouring not only animals but men. The inhabitants dared not leave the city gates. Francis resolved to go out and meet the beast alone.", attr:"" },
    { speaker:"Townsman", text:"Holy brother! Do not go! The wolf has devoured many men ‚Äî he fears nothing! The whole countryside is laid waste by him!", attr:"The Little Flowers of St. Francis, Ch. XXI" },
    { speaker:"Francis", text:"Fear not, brother. I will go to speak with Brother Wolf, in the name of Christ.", attr:"St. Francis, as recorded in the Fioretti" },
    { speaker:"Objective", text:"Go out beyond the city gates and find the wolf. Press ‚úù ACT when near to make peace with him in the name of Christ.", attr:"" },
  ],
  wolf_encounter: [
    { speaker:"Narrator", text:"The wolf, seeing Francis approach, ran at him with open mouth. Francis made the Sign of the Cross, and the wolf slowed, then stopped, and shut its terrible jaws.", attr:"" },
    { speaker:"Francis", text:"\"Come here, Brother Wolf. I command thee on behalf of Christ, that thou do harm neither to me nor to any other person.\"", attr:"The Little Flowers of St. Francis, Chapter XXI, 14th century" },
    { speaker:"Narrator", text:"\"Marvellous to tell, immediately the wolf, at the command of Saint Francis, closed his mouth and stood still... and came gently as a lamb, and laid himself down at the feet of Saint Francis.\"", attr:"The Little Flowers of St. Francis, Ch. XXI" },
    { speaker:"Francis", text:"Brother Wolf, I desire to make peace between you and these people. They will harm you no more, if you will promise never to harm them again. Will you so promise?", attr:"St. Francis, as in Fioretti" },
    { speaker:"Narrator", text:"\"The wolf... bowed his head, and by the movements of his body, his tail, and his eyes, made signs, as well as he was able, that he consented to what Saint Francis had said and would keep his promise.\"", attr:"The Little Flowers of St. Francis, Ch. XXI, 14th century" },
  ],
  stigmata_intro: [
    { speaker:"Narrator", text:"In September 1224, Francis was fasting and praying on the mountain of La Verna, forty days in honor of the Archangel Michael. On the Feast of the Holy Cross, he had a vision of the most extraordinary kind.", attr:"" },
    { speaker:"Francis", text:"\"My Lord Jesus Christ, before I die, I beseech Thee to grant me two graces: the first is that during my life I may feel in my soul and in my body, as much as possible, that pain which Thou, dear Jesus, didst sustain in the hour of Thy most bitter Passion.\"", attr:"The Little Flowers of St. Francis, Second Consideration on the Holy Stigmata" },
    { speaker:"Objective", text:"Ascend La Verna mountain and kneel before the Cross in prayer.", attr:"" },
  ],
  stigmata_miracle: [
    { speaker:"Narrator", text:"\"And suddenly there appeared in the sky a seraph with six resplendent and flaming wings; and as the seraph, flying rapidly, drew near to Francis... he saw in the middle of the vision the form of a man crucified, with hands and feet extended in the form of a cross.\"", attr:"The Little Flowers of St. Francis, Second Consideration on the Holy Stigmata, 14th century" },
    { speaker:"Narrator", text:"\"When the vision vanished, it left in the hands, feet, and side of Francis a wonderful image and impression of the Wounds of our Lord Jesus Christ. His hands and feet seemed to be pierced through the middle with nails, the points of which appeared on the inner side of the hands and on the upper side of the feet.\"", attr:"Thomas of Celano, Vita Prima Sancti Francisci, Ch. III, ¬ß94‚Äì95, 1228" },
    { speaker:"Francis", text:"\"Welcome, Sister Pain. Welcome. I have longed for you, prayed for you. Now bind me more closely to my Lord.\"", attr:"St. Francis, as traditionally attributed" },
    { speaker:"Narrator", text:"Francis received the Stigmata ‚Äî the five wounds of Christ ‚Äî becoming the first recorded person in history to bear them. He kept the wounds hidden from most, wrapping his hands in cloth.", attr:"" },
  ],
  canticle_scene: [
    { speaker:"Narrator", text:"Ill and nearly blind, Francis composed his greatest poem ‚Äî the Canticle of the Sun ‚Äî at San Damiano in 1225, one of the earliest written works of the Italian language.", attr:"" },
    { speaker:"Francis", text:"\"Most High, all-powerful, all-good Lord! All praise is Yours, all glory, all honour and all blessings. To You alone, Most High, do they belong. No mortal lips are worthy to pronounce Your Name.\"", attr:"St. Francis of Assisi, Canticle of the Sun (Canticle of Brother Sun), 1225" },
    { speaker:"Francis", text:"\"Praised be You, my Lord, with all Your creatures, especially Sir Brother Sun, who is the day through whom You give us light. And he is beautiful and radiant with great splendour, of You Most High he bears the likeness.\"", attr:"St. Francis of Assisi, Canticle of the Sun, 1225" },
    { speaker:"Francis", text:"\"Praised be You, my Lord, through Sister Moon and the stars. In the heavens You formed them, clear and precious and beautiful. Praised be You through Brother Wind and through the air, cloudy and serene, and every kind of weather.\"", attr:"St. Francis of Assisi, Canticle of the Sun, 1225" },
    { speaker:"Francis", text:"\"Praised be You through our Sister Mother Earth, who sustains and governs us, and produces varied fruits with coloured flowers and herbs.\"", attr:"St. Francis of Assisi, Canticle of the Sun, 1225" },
  ],
};

// ‚îÄ‚îÄ‚îÄ CUTSCENE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CUTSCENES = [
  {
    art:'‚õ™', title:'STAGE I ‚Äî YOUNG FRANCIS',
    text:'"He was a lover of music, and would often lead his companions through the streets at night singing songs. His manner was gentle, his liberality boundless, his bearing that of a prince... and yet, in the midst of all his joy, something was wanting."\n\n‚Äî Thomas of Celano, Vita Prima Sancti Francisci, c. 1228',
    stageKey:'assisi'
  },
  {
    art:'üèóÔ∏è', title:'STAGE II ‚Äî REBUILD MY CHURCH',
    text:'"Francis heard a voice from the crucifix saying: \'Francis, go and repair my house, which, as you see, is falling into ruins.\' At this, Francis was not a little disturbed. He trembled and was greatly astonished."\n\n‚Äî Three Companions, Legenda Trium Sociorum, c. 1241',
    stageKey:'sanDamiano'
  },
  {
    art:'üïäÔ∏è', title:'STAGE III ‚Äî PREACH TO THE BIRDS',
    text:'"Brother Francis left his companions on the road and ran eagerly to the birds. And when he came close to them they did not fly away, but stayed to hear his sermon. Thus is fulfilled what the prophet said: \'The beasts of the field shall be at peace with thee.\'"\n\n‚Äî Thomas of Celano, Vita Prima, Ch. LVIII',
    stageKey:'birds'
  },
  {
    art:'üê∫', title:'STAGE IV ‚Äî THE WOLF OF GUBBIO',
    text:'"This terrible wolf had not only devoured animals, but had attacked human beings. All the people of the town went about in fear. Saint Francis, having compassion on the people, decided to go out to the wolf."\n\n‚Äî The Little Flowers of St. Francis (Fioretti), Ch. XXI, 14th century',
    stageKey:'wolf'
  },
  {
    art:'‚õ∞Ô∏è', title:'STAGE V ‚Äî THE STIGMATA',
    text:'"The marks of the nails began to appear in his hands and feet, as he had seen them a little before in the figure of the man crucified. His hands and feet seemed to be pierced through the middle with nails."\n\n‚Äî Thomas of Celano, Vita Prima Sancti Francisci, Ch. III, c. 1228',
    stageKey:'laverna'
  },
  {
    art:'‚òÄÔ∏è', title:'FINALE ‚Äî THE CANTICLE OF THE SUN',
    text:'"In the beginning of his conversion Francis had a great tenderness for lepers... he came upon a leper one day and, though he felt great repugnance, he mastered himself, dismounted, and gave the leper a coin, kissing his hand. The leper gave him a kiss of peace, and Francis remounted and rode on; looking back he could see no one at all."\n\n‚Äî St. Bonaventure, Major Life of St. Francis, Ch. I, 1263',
    stageKey:'canticle'
  },
];

// ‚îÄ‚îÄ‚îÄ STAGE INDEX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STAGE_ORDER = ['assisi','sanDamiano','birds','wolf','laverna','canticle'];

// ‚îÄ‚îÄ‚îÄ THREE.JS SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initThree() {
  const canvas = document.getElementById('gameCanvas');
  G.renderer = new THREE.WebGLRenderer({ canvas, antialias: false });
  G.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
  G.renderer.shadowMap.enabled = true;
  G.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  resizeRenderer();

  G.scene = new THREE.Scene();
  G.clock = new THREE.Clock();

  G.camera = new THREE.PerspectiveCamera(70, canvas.width/canvas.height, 0.1, 300);
  G.camera.position.set(0, 6, 14);

  window.addEventListener('resize', resizeRenderer);
}

function resizeRenderer() {
  const w = window.innerWidth, h = window.innerHeight;
  G.renderer.setSize(w, h);
  if (G.camera) {
    G.camera.aspect = w/h;
    G.camera.updateProjectionMatrix();
  }
  const canvas = document.getElementById('gameCanvas');
  canvas.style.width = w+'px';
  canvas.style.height = h+'px';
}

// ‚îÄ‚îÄ‚îÄ PLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createPlayer() {
  const group = new THREE.Group();

  // Body ‚Äî brown robe (N64 low-poly)
  const bodyGeo = new THREE.CylinderGeometry(0.35, 0.5, 1.2, 6);
  const bodyMat = new THREE.MeshLambertMaterial({color:0x6B4226});
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.position.y = 0.6;
  body.castShadow = true;
  group.add(body);

  // Head
  const headGeo = new THREE.SphereGeometry(0.3, 6, 5);
  const headMat = new THREE.MeshLambertMaterial({color:0xDEB887});
  const head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 1.55;
  head.castShadow = true;
  group.add(head);

  // Rope belt
  const beltGeo = new THREE.TorusGeometry(0.37, 0.04, 4, 8);
  const beltMat = new THREE.MeshLambertMaterial({color:0xF5DEB3});
  const belt = new THREE.Mesh(beltGeo, beltMat);
  belt.rotation.x = Math.PI/2;
  belt.position.y = 0.55;
  group.add(belt);

  // Halo (golden ring)
  const haloGeo = new THREE.TorusGeometry(0.38, 0.04, 4, 12);
  const haloMat = new THREE.MeshLambertMaterial({color:0xFFD700, emissive:0xFFD700, emissiveIntensity:0.5});
  const halo = new THREE.Mesh(haloGeo, haloMat);
  halo.position.y = 1.96;
  group.add(halo);

  group.position.set(0, 0, 0);
  G.scene.add(group);
  G.playerMesh = group;

  // Collision capsule (invisible)
  G.player = { x:0, y:0, z:0, r:0.5 };
}

// ‚îÄ‚îÄ‚îÄ ENVIRONMENT BUILDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function clearScene() {
  // Remove all objects except lights
  const toRemove = [];
  G.scene.traverse(obj => {
    if (obj !== G.scene && obj.userData.removable) toRemove.push(obj);
  });
  toRemove.forEach(o => G.scene.remove(o));
  G.interactables = [];
  G.churchPieces = [];
  G.fixedPieces = 0;
  G.birds = [];
  G.wolfMesh = null;
  G.wolfTamed = false;
  G.particles3D = [];
}

function makeRemovable(obj) { obj.userData.removable = true; return obj; }

function buildGround(color=0x4a7c3f, w=80, d=80) {
  const geo = new THREE.PlaneGeometry(w, d, 8, 8);
  const mat = new THREE.MeshLambertMaterial({color});
  const m = new THREE.Mesh(geo, mat);
  m.rotation.x = -Math.PI/2;
  m.receiveShadow = true;
  G.scene.add(makeRemovable(m));
}

function buildSky(color=0x5b9fd4, fogColor=0x5b9fd4) {
  G.scene.background = new THREE.Color(color);
  G.scene.fog = new THREE.Fog(fogColor, 30, 100);
}

function buildLights() {
  const amb = new THREE.AmbientLight(0xfff5cc, 0.6);
  G.scene.add(makeRemovable(amb));
  const sun = new THREE.DirectionalLight(0xffeedd, 1.2);
  sun.position.set(15, 30, 10);
  sun.castShadow = true;
  sun.shadow.mapSize.set(1024,1024);
  G.scene.add(makeRemovable(sun));
}

// Low-poly building block
function makeBox(w,h,d,color,x,y,z,rx=0,ry=0) {
  const geo = new THREE.BoxGeometry(w,h,d);
  const mat = new THREE.MeshLambertMaterial({color});
  const m = new THREE.Mesh(geo,mat);
  m.position.set(x,y,z);
  m.rotation.set(rx,ry,0);
  m.castShadow = true; m.receiveShadow = true;
  G.scene.add(makeRemovable(m));
  return m;
}

// ‚îÄ‚îÄ‚îÄ STAGE: ASSISI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStageAssisi() {
  buildSky(0x87ceeb, 0x87ceeb);
  buildLights();
  buildGround(0x5a8a3a);

  // Rolling hills (low poly)
  for (let i=0; i<6; i++) {
    const r = 4+Math.random()*6;
    const h = 3+Math.random()*5;
    const geo = new THREE.SphereGeometry(r,6,4);
    const mat = new THREE.MeshLambertMaterial({color:0x3d7a3a});
    const m = new THREE.Mesh(geo,mat);
    const angle = (i/6)*Math.PI*2;
    m.position.set(Math.cos(angle)*35, h-r+1, Math.sin(angle)*35);
    m.castShadow = true;
    G.scene.add(makeRemovable(m));
  }

  // Assisi buildings (blocky, medieval)
  const stoneColor = 0xd4c4a0;
  const roofColor = 0x8b3a3a;

  // Main building 1
  makeBox(8,6,6,stoneColor, -12,3,-15);
  makeBox(8,1.5,6,roofColor, -12,6.75,-15);

  // Main building 2
  makeBox(6,8,5,stoneColor, -5,4,-18);
  makeBox(6,1.5,5,roofColor, -5,8.75,-18);

  // Tower
  makeBox(3,12,3,0xc0b090, 6,6,-16);
  makeBox(3,1.5,3,0x7a2020, 6,12.75,-16);

  // Church facade ahead
  makeBox(10,8,2,stoneColor, 0,4,-22);
  makeBox(4,4,2,stoneColor, 0,10,-22);
  makeBox(2,2,2,0xffdd88, 0,13,-22); // bell

  // Arch window
  const archGeo = new THREE.CylinderGeometry(1.5,1.5,0.3,8,1,false,0,Math.PI);
  const archMat = new THREE.MeshLambertMaterial({color:0x2255aa});
  const arch = new THREE.Mesh(archGeo,archMat);
  arch.rotation.set(Math.PI/2,0,0);
  arch.position.set(0,8.5,-21);
  G.scene.add(makeRemovable(arch));

  // Road / cobblestones path
  makeBox(4,0.1,20,0xbbaa88,0,0.05,-12);

  // Trees
  for(let i=0;i<8;i++){
    const angle=(i/8)*Math.PI*2;
    const tx=Math.cos(angle)*18;
    const tz=Math.sin(angle)*15+(-5);
    makeBox(0.6,4,0.6,0x8B4513,tx,2,tz);
    const geo=new THREE.ConeGeometry(2.5,5,6);
    const mat=new THREE.MeshLambertMaterial({color:0x2d6b2d});
    const cone=new THREE.Mesh(geo,mat);
    cone.position.set(tx,7,tz);
    cone.castShadow=true;
    G.scene.add(makeRemovable(cone));
  }

  // NPC Companion
  const npc = makeNPC(0xc47a45, 8,0,2);
  npc.userData.isInteractable = true;
  npc.userData.dialogue = 'assisi_welcome';
  npc.userData.prompt = 'Speak to Companion';
  G.interactables.push(npc);

  // Trigger zone to advance
  const trigger = { x:0, z:-20, r:3, dialogue:'voice_of_god', trigger:'advance', label:'Enter San Damiano Chapel' };
  G.interactables.push(trigger);

  G.player.x=0; G.player.z=0;
  G.playerMesh.position.set(0,0,0);
  G.camera.position.set(0,8,16);
}

// ‚îÄ‚îÄ‚îÄ STAGE: SAN DAMIANO (CHURCH REPAIR) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStageSanDamiano() {
  buildSky(0x7ba3cc, 0x9bb5cc);
  buildLights();
  buildGround(0x8B7355);

  // Church ruins base
  const stoneColor = 0xc8b89a;
  makeBox(14,0.5,10,0xbbaa80,0,0.25,0); // floor

  // Standing walls
  makeBox(14,4,0.8,stoneColor,0,2,-5); // back wall
  makeBox(0.8,6,10,stoneColor,-7,3,0);  // left wall standing

  // Right wall with damage (invisible placeholder)
  makeBox(0.8,3,10,stoneColor,7,1.5,0);

  // BROKEN PIECES ‚Äî stored so we can fix them
  G.churchPieces = [];
  G.fixedPieces = 0;

  // Piece 1: Crumbling right wall upper
  const p1 = makeBrokenPiece(0xaa9977, 0.8,3,10, 7,4.5,0, '‚ë† Crumbling upper wall');
  p1.userData.fixedColor = 0xd4c4a0;

  // Piece 2: Fallen arch
  const p2 = makeBrokenPiece(0x998866, 6,0.8,0.8, 0,6,-5, '‚ë° Fallen arch');
  p2.userData.fixedColor = 0xc0a870;

  // Piece 3: Broken window
  const p3 = makeBrokenPiece(0x7788aa, 2.5,2.5,0.3, 0,4,-5, '‚ë¢ Shattered window');
  p3.userData.fixedColor = 0x4488cc;

  // Piece 4: Collapsed column
  const p4 = makeBrokenPiece(0x999080, 0.6,4,0.6, -5,2,0, '‚ë£ Fallen column');
  p4.userData.fixedColor = 0xd0c0a0;

  // Piece 5: Missing roof section
  const p5 = makeBrokenPiece(0x6a4a2a, 14,0.4,5, 0,7,2, '‚ë§ Missing roof');
  p5.userData.fixedColor = 0x8B4513;

  // Altar at the back
  makeBox(3,1.5,1.5,0xf0e8d0,0,0.75,-4.2);
  const crossGeo = new THREE.BoxGeometry(0.2,2,0.2);
  const crossMat = new THREE.MeshLambertMaterial({color:0xffd700,emissive:0xffd700,emissiveIntensity:0.4});
  const crossV = new THREE.Mesh(crossGeo,crossMat);
  crossV.position.set(0,2.5,-4.2);
  G.scene.add(makeRemovable(crossV));
  const crossH = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.2,0.2),crossMat);
  crossH.position.set(0,3.2,-4.2);
  G.scene.add(makeRemovable(crossH));

  // Rubble piles
  for(let i=0;i<8;i++) {
    const rx=(Math.random()-0.5)*12;
    const rz=(Math.random()-0.5)*8;
    makeBox(0.5+Math.random(),0.3+Math.random()*0.5,0.5+Math.random(), 0x998877, rx,0.3,rz);
  }

  G.player.x=0; G.player.z=8;
  G.playerMesh.position.set(0,0,8);
  G.camera.position.set(0,8,18);

  document.getElementById('objText').innerHTML = 'Repair the 5 broken sections of San Damiano chapel (0/5)';
  document.getElementById('stageProgress').textContent = '‚öí Repaired: 0 / 5';
  document.getElementById('stageProgress').style.display = 'block';
}

function makeBrokenPiece(color, w,h,d, x,y,z, label) {
  // Broken appearance: tilted, jagged color
  const geo = new THREE.BoxGeometry(w,h,d);
  const mat = new THREE.MeshLambertMaterial({color, wireframe:false});
  const m = new THREE.Mesh(geo,mat);
  m.position.set(x,y,z);
  m.rotation.z = (Math.random()-0.5)*0.3;
  m.rotation.x = (Math.random()-0.5)*0.15;
  m.castShadow = true;
  m.userData.broken = true;
  m.userData.label = label;
  m.userData.isInteractable = true;
  m.userData.isChurchPiece = true;
  m.userData.prompt = 'Repair: ' + label;
  G.scene.add(makeRemovable(m));
  G.interactables.push(m);
  G.churchPieces.push(m);
  return m;
}

function repairChurchPiece(piece) {
  if (!piece.userData.broken) return;
  piece.userData.broken = false;
  piece.rotation.set(0,0,0);
  piece.material.color.setHex(piece.userData.fixedColor || 0xd4c4a0);
  piece.material.emissive = new THREE.Color(0xffd700);
  piece.material.emissiveIntensity = 0.3;
  G.fixedPieces++;

  // Golden flash
  showMiracle();
  spawnParticles3D(piece.position, 0xffd700, 30);

  const idx = G.interactables.indexOf(piece);
  if (idx !== -1) G.interactables.splice(idx, 1);

  document.getElementById('stageProgress').textContent = `‚öí Repaired: ${G.fixedPieces} / ${G.totalPieces}`;
  document.getElementById('objText').innerHTML = `Repair the 5 broken sections of San Damiano chapel (${G.fixedPieces}/5)`;

  showDialogue([DIALOGUES.repair_piece[0]]);

  setTimeout(() => {
    piece.material.emissiveIntensity = 0;
  }, 2000);

  if (G.fixedPieces >= G.totalPieces) {
    setTimeout(() => {
      showDialogue(DIALOGUES.repair_complete, () => {
        advanceStage();
      });
    }, 2500);
  }
}

// ‚îÄ‚îÄ‚îÄ STAGE: BIRDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStageBirds() {
  buildSky(0x5b9fd4, 0x82b8d8);
  buildLights();
  buildGround(0x4a9040);

  // Tree cluster for birds to sit
  for(let i=0;i<5;i++){
    const tx = (i-2)*4;
    makeBox(0.5,5,0.5, 0x5D3A1A, tx,2.5,-15);
    const geo=new THREE.ConeGeometry(2.5+i*0.3,6,5);
    const mat=new THREE.MeshLambertMaterial({color:0x2E8B2E});
    const c=new THREE.Mesh(geo,mat);
    c.position.set(tx,9,-15);
    c.castShadow=true;
    G.scene.add(makeRemovable(c));
  }

  // Meadow flowers
  for(let i=0;i<20;i++){
    const geo=new THREE.SphereGeometry(0.2,4,3);
    const colors=[0xff6688,0xffee44,0xff9944,0xee44ff,0x44aaff];
    const mat=new THREE.MeshLambertMaterial({color:colors[i%5]});
    const f=new THREE.Mesh(geo,mat);
    f.position.set((Math.random()-0.5)*30, 0.2,(Math.random()-0.5)*20-5);
    G.scene.add(makeRemovable(f));
  }

  // Hills background
  for(let i=0;i<5;i++){
    const geo=new THREE.SphereGeometry(8+i*3,6,4);
    const mat=new THREE.MeshLambertMaterial({color:0x3a7a3a});
    const hill=new THREE.Mesh(geo,mat);
    hill.position.set((i-2)*20, -4,-30);
    G.scene.add(makeRemovable(hill));
  }

  // Flock of birds (small flat diamonds)
  G.birds = [];
  const birdColors=[0xdd9944,0x448866,0xaa4422,0x334488,0x663322];
  for(let i=0;i<24;i++){
    const spread = (i<12) ? 8 : 12;
    const bx = (Math.random()-0.5)*spread-2;
    const by = 0.5 + Math.floor(i/8)*1.5;
    const bz = -12 + (Math.random()-0.5)*5;
    const geo=new THREE.ConeGeometry(0.25,0.15,4);
    const mat=new THREE.MeshLambertMaterial({color:birdColors[i%5]});
    const bird=new THREE.Mesh(geo,mat);
    bird.position.set(bx,by,bz);
    bird.rotation.x = Math.PI/2;
    bird.userData.origY = by;
    bird.userData.phase = Math.random()*Math.PI*2;
    bird.userData.preached = false;
    G.scene.add(makeRemovable(bird));
    G.birds.push(bird);
  }

  // Trigger zone near birds
  const trigger = {x:0,z:-10,r:4.5,dialogue:'birds_miracle',trigger:'birdsMiracle',label:'Preach to the birds'};
  G.interactables.push(trigger);

  G.player.x=0; G.player.z=5;
  G.playerMesh.position.set(0,0,5);
  G.camera.position.set(0,8,15);

  document.getElementById('objText').innerHTML = 'Walk to the flock of birds and preach to them';
  document.getElementById('stageProgress').style.display='none';
}

// ‚îÄ‚îÄ‚îÄ STAGE: WOLF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStageWolf() {
  buildSky(0x6688aa, 0x7799bb);
  buildLights();
  buildGround(0x4a7040);

  // Dark forest edges
  for(let i=0;i<12;i++){
    const angle=(i/12)*Math.PI*2;
    const r=25+Math.random()*8;
    const tx=Math.cos(angle)*r, tz=Math.sin(angle)*r;
    makeBox(0.8,8+Math.random()*4,0.8,0x3a2510, tx,4,tz);
    const geo=new THREE.ConeGeometry(3+Math.random()*2,8,5);
    const mat=new THREE.MeshLambertMaterial({color:0x1a4a1a});
    const cone=new THREE.Mesh(geo,mat);
    cone.position.set(tx,11,tz);
    G.scene.add(makeRemovable(cone));
  }

  // City gate (Gubbio)
  makeBox(2,8,1,0xc0a880,-4,4,-18);
  makeBox(2,8,1,0xc0a880,4,4,-18);
  makeBox(10,2,1,0xc0a880,0,9,-18);
  const geo=new THREE.CylinderGeometry(2,2,0.5,6);
  const mat=new THREE.MeshLambertMaterial({color:0xaa8855});
  const m=new THREE.Mesh(geo,mat); m.position.set(0,11,-18);
  G.scene.add(makeRemovable(m));

  // Rocks
  for(let i=0;i<10;i++){
    const rx=(Math.random()-0.5)*20, rz=(Math.random()-0.5)*15;
    makeBox(1+Math.random()*1.5,0.5+Math.random(),1+Math.random()*1.5,0x888877,rx,0.5,rz);
  }

  // Wolf
  const wolfGroup = new THREE.Group();
  // body
  const bg=new THREE.BoxGeometry(1.8,1,2.4); const bm=new THREE.MeshLambertMaterial({color:0x556655});
  const body=new THREE.Mesh(bg,bm); body.position.y=0.8; wolfGroup.add(body);
  // head
  const hg=new THREE.BoxGeometry(0.9,0.8,1); const hm=new THREE.MeshLambertMaterial({color:0x4a5a4a});
  const whead=new THREE.Mesh(hg,hm); whead.position.set(0,1.5,-1.5); wolfGroup.add(whead);
  // snout
  const sg=new THREE.BoxGeometry(0.5,0.4,0.5);
  const snout=new THREE.Mesh(sg,hm); snout.position.set(0,1.3,-2.1); wolfGroup.add(snout);
  // legs
  for(let i=0;i<4;i++){
    const lx=(i%2===0?-0.6:0.6), lz=(i<2?-0.7:0.7);
    const leg=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.8,0.3),bm);
    leg.position.set(lx,0.1,lz); wolfGroup.add(leg);
  }
  // tail
  const tail=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,1),bm);
  tail.position.set(0,1.2,1.3); tail.rotation.x=-0.4; wolfGroup.add(tail);

  // eyes (red ‚Äî angry)
  const eyeMat=new THREE.MeshLambertMaterial({color:0xff2200,emissive:0xff0000,emissiveIntensity:0.8});
  const eyeL=new THREE.Mesh(new THREE.SphereGeometry(0.08,4,4),eyeMat);
  eyeL.position.set(-0.2,1.65,-1.95); wolfGroup.add(eyeL);
  const eyeR=eyeL.clone(); eyeR.position.x=0.2; wolfGroup.add(eyeR);

  wolfGroup.position.set(0,0,-10);
  G.scene.add(makeRemovable(wolfGroup));
  G.wolfMesh = wolfGroup;
  wolfGroup.userData.isInteractable = true;
  wolfGroup.userData.prompt = 'Make peace with Brother Wolf';
  G.interactables.push(wolfGroup);

  G.player.x=0; G.player.z=5;
  G.playerMesh.position.set(0,0,5);

  document.getElementById('objText').innerHTML = 'Find and make peace with the wolf terrorizing Gubbio';
  document.getElementById('stageProgress').style.display='none';
}

function tameWolf() {
  if (!G.wolfMesh || G.wolfTamed) return;
  G.wolfTamed = true;

  // Change wolf eyes to peaceful green
  G.wolfMesh.traverse(child => {
    if (child.isMesh && child.material.emissive) {
      child.material.color.setHex(0x88aa66);
      child.material.emissive.setHex(0x004400);
      child.material.emissiveIntensity = 0.2;
    }
  });

  // Make wolf sit (rotate)
  G.wolfMesh.rotation.y = Math.PI; // face Francis
  showMiracle();
  spawnParticles3D(G.wolfMesh.position, 0xaaffaa, 40);

  showDialogue(DIALOGUES.wolf_encounter, () => {
    advanceStage();
  });
}

// ‚îÄ‚îÄ‚îÄ STAGE: LA VERNA (STIGMATA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStageLaVerna() {
  buildSky(0x2233aa, 0x223399);
  G.scene.fog = new THREE.Fog(0x223399, 20, 80);
  buildLights();
  buildGround(0x5a4a3a);

  // Rocky mountain (La Verna)
  for(let i=0;i<5;i++){
    const s=5+i*3;
    const geo=new THREE.ConeGeometry(s,s*1.5,5);
    const mat=new THREE.MeshLambertMaterial({color:[0x6a5a4a,0x5a4a3a,0x4a3a2a,0x7a6a5a,0x8a7a6a][i]});
    const cone=new THREE.Mesh(geo,mat);
    cone.position.set((i-2)*2, s*0.75-1, -20-i*3);
    cone.castShadow=true;
    G.scene.add(makeRemovable(cone));
  }

  // Rocky path upward
  for(let i=0;i<8;i++){
    makeBox(3,0.3,1.5,0x8a7a6a, 0, i*0.8, -i*2.5-2);
  }

  // Summit cross (glowing)
  const crossMat=new THREE.MeshLambertMaterial({color:0xffdd88,emissive:0xffdd00,emissiveIntensity:0.8});
  const cv=new THREE.Mesh(new THREE.BoxGeometry(0.3,4,0.3),crossMat);
  cv.position.set(0,12,-20);
  G.scene.add(makeRemovable(cv));
  const ch=new THREE.Mesh(new THREE.BoxGeometry(2.5,0.3,0.3),crossMat);
  ch.position.set(0,13.5,-20);
  G.scene.add(makeRemovable(ch));

  // Animated glow point light
  const glow=new THREE.PointLight(0xffd700,2,15);
  glow.position.set(0,14,-20);
  glow.userData.glow=true;
  G.scene.add(makeRemovable(glow));

  // Stars in sky
  const starGeo=new THREE.BufferGeometry();
  const starPos=[];
  for(let i=0;i<300;i++){
    starPos.push((Math.random()-0.5)*200,(20+Math.random()*80),(Math.random()-0.5)*200-30);
  }
  starGeo.setAttribute('position',new THREE.Float32BufferAttribute(starPos,3));
  const starMat=new THREE.PointsMaterial({color:0xffffff,size:0.3});
  const stars=new THREE.Points(starGeo,starMat);
  G.scene.add(makeRemovable(stars));

  // Trigger zone at summit
  const trigger={x:0,z:-19,r:3.5,dialogue:'stigmata_miracle',trigger:'stigmata',label:'Receive the Stigmata'};
  G.interactables.push(trigger);

  G.player.x=0; G.player.z=5;
  G.playerMesh.position.set(0,0,5);

  document.getElementById('objText').innerHTML = 'Ascend La Verna and pray before the Cross';
  document.getElementById('stageProgress').style.display='none';
}

// ‚îÄ‚îÄ‚îÄ STAGE: CANTICLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStageCanticle() {
  buildSky(0xffa040, 0xff8020);
  G.scene.fog = new THREE.Fog(0xff9030, 25, 90);

  // Sunset/golden lights
  const amb=new THREE.AmbientLight(0xffddaa,0.8);
  G.scene.add(makeRemovable(amb));
  const sun=new THREE.DirectionalLight(0xff8844,1.5);
  sun.position.set(-20,15,10);
  G.scene.add(makeRemovable(sun));

  buildGround(0x8a6a40);

  // San Damiano facade (restored ‚Äî beautiful now)
  const stoneColor=0xd4c090;
  makeBox(12,8,2,stoneColor,0,4,-20);
  makeBox(5,4,2,stoneColor,0,10,-20);
  makeBox(2.5,2.5,2,0xffdd88,0,13.5,-20);
  makeBox(0.25,3,0.25,0xffd700,0,15,-20);
  makeBox(1.5,0.25,0.25,0xffd700,0,16,-20);

  // Garden roses and plants
  for(let i=0;i<15;i++){
    const rx=(Math.random()-0.5)*14, rz=(Math.random()-0.5)*10-5;
    const colors=[0xff4466,0xff8844,0xffee44,0xee44aa,0xff6688];
    makeBox(0.15,0.8,0.15,0x228822,rx,0.4,rz);
    const head=new THREE.Mesh(new THREE.SphereGeometry(0.3,5,4),new THREE.MeshLambertMaterial({color:colors[i%5]}));
    head.position.set(rx,1,rz);
    G.scene.add(makeRemovable(head));
  }

  // Birds flying overhead
  G.birds=[];
  for(let i=0;i<10;i++){
    const bx=(Math.random()-0.5)*20;
    const by=8+Math.random()*6;
    const bz=(Math.random()-0.5)*15;
    const geo=new THREE.ConeGeometry(0.3,0.18,4);
    const bird=new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color:0x88aacc}));
    bird.position.set(bx,by,bz);
    bird.userData.phase=Math.random()*Math.PI*2;
    G.scene.add(makeRemovable(bird));
    G.birds.push(bird);
  }

  // Sun disc
  const sunGeo=new THREE.CircleGeometry(8,16);
  const sunMat=new THREE.MeshBasicMaterial({color:0xffcc00,side:THREE.DoubleSide});
  const sunDisc=new THREE.Mesh(sunGeo,sunMat);
  sunDisc.position.set(-40,25,-50);
  sunDisc.rotation.y=0.4;
  G.scene.add(makeRemovable(sunDisc));

  // NPC Clare (Sister Clare)
  const npc=makeNPC(0x4488cc,5,0,0);
  npc.userData.isInteractable=true;
  npc.userData.dialogue='canticle_scene';
  npc.userData.prompt='Speak with Sister Clare';
  G.interactables.push(npc);

  // Ending trigger
  const trigger={x:0,z:-18,r:4,trigger:'ending',label:'Enter the chapel ‚Äî sing the Canticle of the Sun'};
  G.interactables.push(trigger);

  G.player.x=0; G.player.z=6;
  G.playerMesh.position.set(0,0,6);

  document.getElementById('objText').innerHTML = 'Approach the restored chapel and sing the Canticle of the Sun';
  document.getElementById('stageProgress').style.display='none';
}

// ‚îÄ‚îÄ‚îÄ NPC HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeNPC(color, x,y,z) {
  const g=new THREE.Group();
  const body=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.4,1,6),new THREE.MeshLambertMaterial({color}));
  body.position.y=0.5;
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.26,6,5),new THREE.MeshLambertMaterial({color:0xDEB887}));
  head.position.y=1.3;
  g.add(body,head);
  g.position.set(x,y,z);
  g.castShadow=true;
  g.userData.isNPC=true;
  G.scene.add(makeRemovable(g));
  return g;
}

// ‚îÄ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnParticles3D(pos, color=0xffd700, count=20) {
  for(let i=0;i<count;i++){
    const geo=new THREE.SphereGeometry(0.08,4,4);
    const mat=new THREE.MeshBasicMaterial({color,transparent:true,opacity:1});
    const p=new THREE.Mesh(geo,mat);
    p.position.copy(pos);
    p.userData.vel=new THREE.Vector3((Math.random()-0.5)*0.2,(Math.random()*0.15+0.05),(Math.random()-0.5)*0.2);
    p.userData.life=1;
    G.scene.add(makeRemovable(p));
    G.particles3D.push(p);
  }
}

function updateParticles3D(dt) {
  for(let i=G.particles3D.length-1;i>=0;i--){
    const p=G.particles3D[i];
    p.userData.life-=dt*0.8;
    p.position.add(p.userData.vel);
    p.material.opacity=p.userData.life;
    if(p.userData.life<=0){
      G.scene.remove(p);
      G.particles3D.splice(i,1);
    }
  }
}

function showMiracle() {
  const el=document.getElementById('miraceEffect');
  el.style.display='block';
  setTimeout(()=>el.style.display='none',600);
}

// ‚îÄ‚îÄ‚îÄ DIALOGUE SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let dlgQueue=[], dlgIdx=0, dlgCallback=null;

function showDialogue(lines, cb=null) {
  if(!lines || lines.length===0) { if(cb) cb(); return; }
  dlgQueue=lines; dlgIdx=0; dlgCallback=cb;
  G.dialogueActive=true;
  renderDlg();
  document.getElementById('dialogueBox').style.display='block';
}

function renderDlg(){
  if(dlgIdx>=dlgQueue.length){
    closeDlg();
    return;
  }
  const d=dlgQueue[dlgIdx];
  document.getElementById('dlgSpeaker').textContent=d.speaker||'';
  document.getElementById('dlgText').textContent=d.text||'';
  document.getElementById('dlgAttr').textContent=d.attr||'';
}

function closeDlg(){
  G.dialogueActive=false;
  document.getElementById('dialogueBox').style.display='none';
  dlgQueue=[]; dlgIdx=0;
  if(dlgCallback){const c=dlgCallback; dlgCallback=null; c();}
}

function handleDialogueContinue(){
  if(!G.dialogueActive) return;
  dlgIdx++;
  if(dlgIdx>=dlgQueue.length) closeDlg();
  else renderDlg();
}

// ‚îÄ‚îÄ‚îÄ CUTSCENE SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cutsceneQueue=[], cutsceneIdx=0, cutsceneCallback=null;

function showCutscene(data, cb){
  cutsceneQueue=[data]; cutsceneIdx=0; cutsceneCallback=cb;
  document.getElementById('cutArt').textContent=data.art||'‚úù';
  document.getElementById('cutTitle').textContent=data.title||'';
  document.getElementById('cutText').textContent=data.text||'';
  document.getElementById('cutscene').style.display='flex';
}

function cutsceneContinue(){
  document.getElementById('cutscene').style.display='none';
  if(cutsceneCallback){const c=cutsceneCallback;cutsceneCallback=null;c();}
}

// ‚îÄ‚îÄ‚îÄ INTERACTION SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkInteractables(){
  const px=G.player.x, pz=G.player.z;
  let nearest=null, nearestDist=Infinity;
  const pr=G.player.r||0.5;

  for(const obj of G.interactables){
    let ox,oz,or;
    if(obj.isObject3D){
      ox=obj.position.x; oz=obj.position.z; or=2;
    } else {
      ox=obj.x; oz=obj.z; or=obj.r||2;
    }
    const dx=px-ox, dz=pz-oz;
    const dist=Math.sqrt(dx*dx+dz*dz);
    if(dist<or+pr+0.5 && dist<nearestDist){
      nearestDist=dist; nearest=obj;
    }
  }
  G.interactable=nearest;
  const prompt=document.getElementById('interactPrompt');
  if(nearest){
    const label=nearest.userData?.prompt||nearest.label||'Interact';
    prompt.innerHTML=`‚úù ACT ‚Äî ${label}`;
    prompt.style.display='block';
  } else {
    prompt.style.display='none';
  }
}

function handleInteract(){
  if(G.dialogueActive){ handleDialogueContinue(); return; }
  if(!G.interactable) return;
  const obj=G.interactable;

  if(obj.userData?.isChurchPiece && obj.userData.broken){
    repairChurchPiece(obj);
    return;
  }
  if(obj===G.wolfMesh && !G.wolfTamed){
    showDialogue(DIALOGUES.wolf_intro.slice(-1));
    tameWolf();
    return;
  }
  if(obj.userData?.dialogue){
    const d=DIALOGUES[obj.userData.dialogue];
    if(d) showDialogue(d);
    return;
  }
  if(obj.trigger==='advance') { advanceStage(); return; }
  if(obj.trigger==='birdsMiracle') { handleBirdsMiracle(); return; }
  if(obj.trigger==='stigmata') { handleStigmata(); return; }
  if(obj.trigger==='ending') { showEnding(); return; }
}

function handleBirdsMiracle(){
  if(G.birdsPeached) return;
  G.birdsPeached=true;
  const idx=G.interactables.findIndex(o=>o.trigger==='birdsMiracle');
  if(idx!==-1) G.interactables.splice(idx,1);
  showMiracle();
  spawnParticles3D(G.playerMesh.position,0xaaffff,50);
  // Birds animate
  G.birds.forEach((b,i)=>{
    b.userData.dancing=true;
    setTimeout(()=>{b.userData.dancing=false;},4000);
  });
  showDialogue(DIALOGUES.birds_miracle, ()=>{ advanceStage(); });
}

function handleStigmata(){
  if(G.stigmataReceived) return;
  G.stigmataReceived=true;
  const idx=G.interactables.findIndex(o=>o.trigger==='stigmata');
  if(idx!==-1) G.interactables.splice(idx,1);

  // Flash of gold/white light
  const el=document.getElementById('miraceEffect');
  el.style.background='radial-gradient(ellipse at center, rgba(255,255,255,0.99) 0%, rgba(255,215,0,0.8) 30%, transparent 70%)';
  el.style.display='block';
  setTimeout(()=>{el.style.display='none'; el.style.background='';},1200);

  spawnParticles3D(G.playerMesh.position,0xffffff,80);
  spawnParticles3D(G.playerMesh.position,0xffd700,60);

  showDialogue(DIALOGUES.stigmata_miracle, ()=>{ advanceStage(); });
}

function showEnding(){
  showDialogue(DIALOGUES.canticle_scene, ()=>{
    setTimeout(()=>{
      document.getElementById('finalScreen').style.display='flex';
    },500);
  });
}

// ‚îÄ‚îÄ‚îÄ STAGE MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentCutsceneIdx = -1;

function advanceStage(){
  G.stageIndex++;
  if(G.stageIndex>=CUTSCENES.length){
    // All done
    document.getElementById('finalScreen').style.display='flex';
    return;
  }
  loadStage(G.stageIndex);
}

function loadStage(idx){
  G.stageIndex=idx;
  const cutData=CUTSCENES[idx];
  if(!cutData) return;

  // Hide game UI temporarily
  document.getElementById('stageBanner').style.display='none';
  document.getElementById('objectiveBar').style.display='none';
  document.getElementById('dpad').style.display='none';
  document.getElementById('actionBtns').style.display='none';
  G.dialogueActive=false;
  document.getElementById('dialogueBox').style.display='none';
  document.getElementById('interactPrompt').style.display='none';

  showCutscene(cutData, ()=>{
    clearScene();
    buildPlayerAndScene(cutData.stageKey);
    // Show in-stage intro dialogue
    const introKey = cutData.stageKey + '_intro';
    const introDlg = DIALOGUES[introKey];
    document.getElementById('stageBanner').textContent = cutData.title;
    document.getElementById('stageBanner').style.display='block';
    document.getElementById('objectiveBar').style.display='block';
    document.getElementById('dpad').style.display='block';
    document.getElementById('actionBtns').style.display='flex';
    if(introDlg){
      showDialogue(introDlg);
    }
  });
}

function buildPlayerAndScene(key){
  createPlayer();
  switch(key){
    case 'assisi': buildStageAssisi(); break;
    case 'sanDamiano': buildStageSanDamiano(); break;
    case 'birds': buildStageBirds(); break;
    case 'wolf': buildStageWolf(); break;
    case 'laverna': buildStageLaVerna(); break;
    case 'canticle': buildStageCanticle(); break;
  }
}

// ‚îÄ‚îÄ‚îÄ MOVEMENT & CAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SPEED = 5;
const CAM_HEIGHT = 7;
const CAM_DIST = 14;
let camAngle = 0;

function updateMovement(dt){
  if(G.dialogueActive) return;

  let mx=G.moveInput.x, mz=G.moveInput.z;

  // 8-directional keyboard
  if(G.keys['ArrowUp']||G.keys['KeyW']) mz=-1;
  if(G.keys['ArrowDown']||G.keys['KeyS']) mz=1;
  if(G.keys['ArrowLeft']||G.keys['KeyA']) mx=-1;
  if(G.keys['ArrowRight']||G.keys['KeyD']) mx=1;
  if(G.keys['ArrowUp']&&G.keys['ArrowLeft']||G.keys['KeyW']&&G.keys['KeyA']){mx=-0.707;mz=-0.707;}
  if(G.keys['ArrowUp']&&G.keys['ArrowRight']||G.keys['KeyW']&&G.keys['KeyD']){mx=0.707;mz=-0.707;}
  if(G.keys['ArrowDown']&&G.keys['ArrowLeft']||G.keys['KeyS']&&G.keys['KeyA']){mx=-0.707;mz=0.707;}
  if(G.keys['ArrowDown']&&G.keys['ArrowRight']||G.keys['KeyS']&&G.keys['KeyD']){mx=0.707;mz=0.707;}

  const len=Math.sqrt(mx*mx+mz*mz);
  if(len>0.01){
    mx/=len; mz/=len;
    G.player.x+=mx*SPEED*dt;
    G.player.z+=mz*SPEED*dt;
    G.playerMesh.position.x=G.player.x;
    G.playerMesh.position.z=G.player.z;
    G.playerMesh.position.y=0;
    // Face direction
    G.playerMesh.rotation.y=Math.atan2(mx,mz);
    // Bob animation
    G.playerMesh.position.y=Math.abs(Math.sin(G.frameCount*0.15))*0.1;
  }
}

function updateCamera(){
  const px=G.player.x, pz=G.player.z;
  const tx=px;
  const ty=CAM_HEIGHT;
  const tz=pz+CAM_DIST;
  G.camera.position.x+=(tx-G.camera.position.x)*0.08;
  G.camera.position.y+=(ty-G.camera.position.y)*0.08;
  G.camera.position.z+=(tz-G.camera.position.z)*0.08;
  G.camera.lookAt(px, 1, pz);
}

// ‚îÄ‚îÄ‚îÄ BIRDS ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateBirds(t){
  G.birds.forEach((b,i)=>{
    if(b.userData.dancing){
      b.position.y=(b.userData.origY||1)+Math.sin(t*5+i)*0.5;
      b.rotation.z=Math.sin(t*8+i)*0.4;
      b.rotation.x=Math.PI/2+Math.sin(t*6+i)*0.3;
    } else {
      b.position.y=(b.userData.origY||5)+Math.sin(t*1.5+b.userData.phase)*0.4;
      b.position.x+=Math.sin(t+b.userData.phase)*0.01;
      b.rotation.z=Math.sin(t*2+b.userData.phase)*0.2;
    }
  });
}

// ‚îÄ‚îÄ‚îÄ WOLF ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateWolf(t){
  if(!G.wolfMesh) return;
  if(!G.wolfTamed){
    G.wolfMesh.position.y=Math.abs(Math.sin(t*3))*0.1;
  } else {
    // Peaceful wag
    G.wolfMesh.children.forEach(c=>{
      if(c.position.z>1){ c.rotation.y=Math.sin(t*8)*0.4; }
    });
  }
}

// ‚îÄ‚îÄ‚îÄ GLOW ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateGlows(t){
  G.scene.traverse(obj=>{
    if(obj.isLight && obj.userData.glow){
      obj.intensity=1.5+Math.sin(t*3)*0.5;
    }
  });
}

// ‚îÄ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mainLoop(ts){
  G.animId=requestAnimationFrame(mainLoop);
  const elapsed=ts-G.lastFrame;
  if(elapsed < G.targetMs) return; // cap to 144fps
  G.lastFrame=ts;
  const dt=Math.min(elapsed/1000, 0.05);
  const t=ts/1000;
  G.frameCount++;

  if(G.stage==='playing'){
    updateMovement(dt);
    updateCamera();
    updateParticles3D(dt);
    updateBirds(t);
    updateWolf(t);
    updateGlows(t);
    checkInteractables();
  }

  G.renderer.render(G.scene,G.camera);
}

// ‚îÄ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupInput(){
  document.addEventListener('keydown', e=>{
    G.keys[e.code]=true;
    if(e.code==='Space'||e.code==='Enter') handleDialogueContinue();
    if(e.code==='KeyE'||e.code==='KeyF') handleInteract();
    if(e.code==='Escape') cutsceneContinue();
    e.preventDefault();
  });
  document.addEventListener('keyup', e=>{ G.keys[e.code]=false; });

  // Touch D-pad
  const dirMap={
    'u':{x:0,z:-1},'d':{x:0,z:1},'l':{x:-1,z:0},'r':{x:1,z:0},
    'ul':{x:-0.707,z:-0.707},'ur':{x:0.707,z:-0.707},
    'dl':{x:-0.707,z:0.707},'dr':{x:0.707,z:0.707}
  };
  document.querySelectorAll('.dpad-btn[data-dir]').forEach(btn=>{
    const dir=btn.dataset.dir;
    ['touchstart','mousedown'].forEach(ev=>{
      btn.addEventListener(ev,e=>{
        e.preventDefault();
        const d=dirMap[dir];
        if(d){G.moveInput.x=d.x;G.moveInput.z=d.z;}
        btn.classList.add('pressed');
      },{passive:false});
    });
    ['touchend','mouseup','mouseleave','touchcancel'].forEach(ev=>{
      btn.addEventListener(ev,e=>{
        G.moveInput.x=0;G.moveInput.z=0;
        btn.classList.remove('pressed');
      });
    });
  });

  // Cutscene advance on tap
  document.getElementById('cutscene').addEventListener('click', cutsceneContinue);
  document.getElementById('dialogueBox').addEventListener('click', handleDialogueContinue);
}

// ‚îÄ‚îÄ‚îÄ GAME START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame(){
  document.getElementById('titleScreen').style.display='none';
  G.stage='playing';

  // Init 3D
  initThree();
  createPlayer();
  setupInput();

  // Stage 0: Assisi ‚Äî show its cutscene first
  loadStage(0);

  // Start loop
  requestAnimationFrame(ts=>{G.lastFrame=ts; mainLoop(ts);});
}

// ‚îÄ‚îÄ‚îÄ LOADING SEQUENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', ()=>{
  const fill=document.getElementById('loadingFill');
  let pct=0;
  const interval=setInterval(()=>{
    pct+=Math.random()*25;
    if(pct>=100){pct=100;clearInterval(interval);
      setTimeout(()=>{
        document.getElementById('loading').style.display='none';
        document.getElementById('titleScreen').style.display='flex';
      },400);
    }
    fill.style.width=pct+'%';
  },200);
});

// ‚îÄ‚îÄ‚îÄ PARTICLE CSS OVERLAY (complementary) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnCSSParticle(){
  if(G.stage!=='playing') return;
  const overlay=document.getElementById('particleOverlay');
  const p=document.createElement('div');
  p.className='particle';
  const size=2+Math.random()*5;
  const colors=['#ffd700','#ff8c00','#fff5aa','#ffffff','#ffeebb'];
  p.style.cssText=`
    width:${size}px;height:${size}px;
    left:${Math.random()*100}%;
    bottom:0;
    background:${colors[Math.floor(Math.random()*colors.length)]};
    opacity:${0.3+Math.random()*0.4};
    animation-duration:${4+Math.random()*6}s;
    animation-delay:${Math.random()*2}s;
  `;
  overlay.appendChild(p);
  setTimeout(()=>p.remove(),10000);
}
setInterval(spawnCSSParticle,800);
</script>
</body>
</html>
