<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>The Life of Saint Francis of Assisi</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cinzel+Decorative:wght@400;700&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:#000;position:fixed;top:0;left:0;-webkit-tap-highlight-color:transparent;touch-action:none;}
#gameCanvas{position:fixed;top:0;left:0;width:100%!important;height:100%!important;display:block;image-rendering:pixelated;image-rendering:crisp-edges;touch-action:none;}
#loading{position:fixed;inset:0;z-index:999;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;font-family:'Cinzel',serif;color:#ffd700;}
#loading .lc{font-size:clamp(40px,10vw,80px);animation:glowPulse 1.5s ease-in-out infinite;}
#loading .lt{font-size:clamp(12px,3vw,22px);letter-spacing:4px;text-transform:uppercase;}
#loadingBar{width:min(300px,70vw);height:6px;background:#1a0a2e;border:2px solid #8B6914;border-radius:3px;overflow:hidden;}
#loadingFill{height:100%;background:linear-gradient(to right,#8B6914,#ffd700);width:0%;transition:width .25s;}
@keyframes glowPulse{0%,100%{text-shadow:0 0 20px #ffd700,0 0 40px #ff8c00;}50%{text-shadow:0 0 50px #ffd700,0 0 100px #ff8c00,0 0 140px #ffd700;}}
@keyframes fadeDown{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
@keyframes blinkAnim{0%,100%{opacity:1;}50%{opacity:.25;}}
@keyframes btnPulse{0%,100%{box-shadow:0 0 20px rgba(255,215,0,.4);}50%{box-shadow:0 0 50px rgba(255,215,0,.95);}}
@keyframes floatUp{from{transform:translateY(0) scale(1);opacity:.8;}to{transform:translateY(-110vh) scale(.3);opacity:0;}}
@keyframes miracleAnim{0%{opacity:0;transform:scale(.4);}35%{opacity:1;transform:scale(1.05);}100%{opacity:0;transform:scale(1.6);}}
#titleScreen{position:fixed;inset:0;z-index:100;background:radial-gradient(ellipse at center,#1a0a2e 0%,#06000f 70%,#000 100%);display:none;flex-direction:column;align-items:center;justify-content:center;font-family:'Cinzel',serif;pointer-events:all;overflow:hidden;padding:clamp(12px,4vw,28px);}
.title-stars{position:absolute;inset:0;pointer-events:none;background-image:radial-gradient(1px 1px at 12% 18%,#fff 100%,transparent),radial-gradient(1px 1px at 78% 8%,#fff 100%,transparent),radial-gradient(1px 1px at 44% 65%,#fff 100%,transparent),radial-gradient(1px 1px at 6% 82%,#fff 100%,transparent),radial-gradient(1px 1px at 92% 57%,#fff 100%,transparent),radial-gradient(1px 1px at 31% 12%,#fff 100%,transparent),radial-gradient(2px 2px at 55% 55%,#ffd700 100%,transparent),radial-gradient(2px 2px at 24% 74%,#ffd700 100%,transparent);}
.title-cross{font-size:clamp(44px,12vw,100px);color:#ffd700;text-shadow:0 0 30px #ffd700,0 0 60px #ff8c00;animation:glowPulse 2s ease-in-out infinite;line-height:1.1;}
.title-main{font-family:'Cinzel Decorative',serif;font-size:clamp(15px,4.5vw,44px);color:#ffd700;text-align:center;letter-spacing:3px;line-height:1.35;text-shadow:3px 3px 0 #5a3c00,6px 6px 10px rgba(0,0,0,.8);animation:fadeDown 1.2s ease-out both;margin-top:6px;}
.title-sub{font-size:clamp(8px,2vw,16px);color:#d4af37;letter-spacing:5px;margin-top:6px;animation:fadeDown 1.2s ease-out .3s both;}
.title-bio{max-width:min(660px,90vw);margin-top:16px;padding:14px 20px;background:rgba(0,0,0,.65);border:2px solid #8B6914;border-radius:4px;color:#e8d5a0;font-style:italic;font-size:clamp(8px,1.7vw,13px);line-height:1.75;text-align:center;animation:fadeDown 1.2s ease-out .6s both;}
.title-bio-attr{color:#ffd700;font-style:normal;font-size:.85em;margin-top:5px;display:block;}
.start-btn{margin-top:18px;padding:clamp(9px,1.8vh,15px) clamp(24px,5vw,52px);background:linear-gradient(135deg,#6a4c00,#ffd700,#6a4c00);border:3px solid #ffd700;color:#1a0a2e;font-family:'Cinzel',serif;font-size:clamp(10px,2vw,16px);font-weight:700;letter-spacing:4px;text-transform:uppercase;cursor:pointer;border-radius:4px;animation:fadeDown 1.2s ease-out .9s both,btnPulse 2s ease-in-out 2.5s infinite;transition:transform .1s;}
.start-btn:hover{transform:scale(1.05);}.start-btn:active{transform:scale(.95);}
#cutscene{position:fixed;inset:0;z-index:90;background:#000;display:none;flex-direction:column;align-items:center;justify-content:center;pointer-events:all;padding:clamp(12px,3vw,24px);gap:10px;}
.cut-art{font-size:clamp(56px,16vw,140px);text-align:center;line-height:1;}
.cut-title{font-family:'Cinzel Decorative',serif;font-size:clamp(12px,3.2vw,30px);color:#ffd700;letter-spacing:3px;text-transform:uppercase;text-align:center;text-shadow:0 0 20px #ffd700;}
.cut-text{max-width:min(680px,90vw);font-family:'Cinzel',serif;font-size:clamp(9px,1.9vw,14px);color:#e8d5a0;line-height:1.85;font-style:italic;text-align:center;padding:14px 18px;background:rgba(0,0,0,.6);border:1px solid #8B6914;border-radius:4px;white-space:pre-line;}
.cut-continue{color:#ffd700;font-family:'Cinzel',serif;font-size:clamp(9px,1.7vw,13px);letter-spacing:2px;animation:blinkAnim 1s ease-in-out infinite;padding:9px 26px;border:2px solid #8B6914;border-radius:4px;background:rgba(0,0,0,.5);cursor:pointer;text-align:center;}
#stageBanner{position:fixed;top:0;left:0;right:0;z-index:20;text-align:center;padding:10px 20px;background:linear-gradient(to bottom,rgba(0,0,0,.88),transparent);color:#ffd700;font-family:'Cinzel Decorative',serif;font-size:clamp(8px,2vw,15px);letter-spacing:3px;text-shadow:2px 2px 4px #000;pointer-events:none;display:none;text-transform:uppercase;}
#objectiveBar{position:fixed;top:44px;left:10px;z-index:20;background:rgba(0,0,0,.78);border:2px solid #8B6914;border-radius:4px;padding:7px 12px;font-family:'Cinzel',serif;pointer-events:none;display:none;max-width:min(240px,40vw);}
#objectiveBar .obj-title{color:#d4af37;font-size:clamp(6px,1.3vw,10px);letter-spacing:2px;text-transform:uppercase;}
#objectiveBar .obj-text{color:#e8d5a0;font-size:clamp(7px,1.5vw,11px);margin-top:3px;line-height:1.5;}
#stageProgress{position:fixed;top:44px;right:10px;z-index:20;background:rgba(0,0,0,.78);border:2px solid #8B6914;border-radius:4px;padding:7px 12px;text-align:right;color:#ffd700;font-family:'Cinzel',serif;font-size:clamp(7px,1.5vw,11px);pointer-events:none;display:none;}
#dialogueBox{position:fixed;bottom:clamp(80px,14vh,120px);left:50%;transform:translateX(-50%);width:min(800px,94vw);z-index:30;background:rgba(8,4,20,.96);border:3px solid #8B6914;border-radius:6px;padding:13px 17px;font-family:'Cinzel',serif;pointer-events:all;display:none;box-shadow:0 0 30px rgba(139,105,20,.5),inset 0 0 20px rgba(0,0,0,.5);}
#dialogueBox .dlg-speaker{color:#ffd700;font-size:clamp(8px,1.6vw,13px);font-weight:700;margin-bottom:4px;letter-spacing:2px;}
#dialogueBox .dlg-text{color:#e8d5a0;font-size:clamp(8px,1.6vw,13px);line-height:1.72;font-style:italic;}
#dialogueBox .dlg-attr{color:#b8922a;font-size:clamp(6px,1.2vw,10px);margin-top:6px;font-style:normal;text-align:right;}
#dialogueBox .dlg-hint{color:#555;font-size:clamp(6px,1.2vw,10px);margin-top:5px;text-align:center;animation:blinkAnim 1s ease-in-out infinite;}
#interactPrompt{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.84);border:2px solid #ffd700;border-radius:4px;padding:8px 16px;color:#ffd700;font-family:'Cinzel',serif;font-size:clamp(8px,1.8vw,13px);display:none;z-index:25;pointer-events:none;text-align:center;animation:blinkAnim 1s ease-in-out infinite;}
/* JOYSTICK */
#joystickWrap{position:fixed;bottom:clamp(16px,3vh,28px);left:clamp(16px,3vw,28px);width:clamp(100px,22vw,130px);height:clamp(100px,22vw,130px);display:none;z-index:40;pointer-events:all;user-select:none;-webkit-user-select:none;touch-action:none;}
#joystickBase{width:100%;height:100%;border-radius:50%;background:rgba(0,0,0,.5);border:3px solid rgba(255,215,0,.45);position:relative;box-shadow:0 0 12px rgba(0,0,0,.4);}
#joystickKnob{position:absolute;width:40%;height:40%;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(255,215,0,.9),rgba(180,120,0,.8));border:2px solid rgba(255,215,0,.9);top:50%;left:50%;transform:translate(-50%,-50%);box-shadow:0 2px 8px rgba(0,0,0,.5);pointer-events:none;display:flex;align-items:center;justify-content:center;color:rgba(120,60,0,.8);font-size:clamp(10px,3vw,16px);font-weight:bold;}
/* ACTION BUTTONS */
#actionBtns{position:fixed;bottom:clamp(16px,3vh,28px);right:clamp(16px,3vw,28px);display:none;z-index:40;flex-direction:column;align-items:flex-end;gap:10px;pointer-events:all;}
.act-btn{width:clamp(52px,13vw,68px);height:clamp(52px,13vw,68px);border-radius:50%;border:3px solid rgba(255,215,0,.85);background:rgba(20,10,40,.85);color:#ffd700;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;user-select:none;font-family:'Cinzel',serif;line-height:1.2;touch-action:manipulation;box-shadow:0 0 14px rgba(255,215,0,.3);transition:transform .08s,background .08s;}
.act-btn:active,.act-btn.pressed{background:rgba(139,105,20,.75);transform:scale(.91);}
#btnAct{font-size:clamp(16px,4vw,22px);animation:btnPulse 2s ease-in-out 1s infinite;}
#btnAct .btn-label{font-size:clamp(6px,1.4vw,9px);letter-spacing:1px;margin-top:1px;}
#btnNext{font-size:clamp(16px,4vw,20px);}
/* MIRACLE FLASH */
#miracleFlash{position:fixed;inset:0;z-index:50;pointer-events:none;display:none;background:radial-gradient(ellipse at center,rgba(255,215,0,.9) 0%,rgba(255,140,0,.5) 40%,transparent 70%);}
#miracleFlash.active{display:block;animation:miracleAnim .7s ease-out forwards;}
#miracleFlash.white{background:radial-gradient(ellipse at center,rgba(255,255,255,.99) 0%,rgba(255,215,0,.75) 30%,transparent 65%);}
#particleOverlay{position:fixed;inset:0;pointer-events:none;z-index:5;overflow:hidden;}
.cssParticle{position:absolute;border-radius:50%;pointer-events:none;animation:floatUp linear forwards;}
#finalScreen{position:fixed;inset:0;z-index:95;background:radial-gradient(ellipse at center,#fff5cc 0%,#ffd700 25%,#ff8c00 55%,#1a0a2e 100%);display:none;flex-direction:column;align-items:center;justify-content:center;font-family:'Cinzel',serif;pointer-events:all;padding:clamp(16px,4vw,32px);gap:14px;overflow-y:auto;}
.final-title{font-family:'Cinzel Decorative',serif;font-size:clamp(16px,4.5vw,44px);color:#1a0a2e;text-align:center;font-weight:700;text-shadow:2px 2px 0 rgba(255,255,255,.4);animation:fadeDown 1.5s ease-out;}
.final-quote{max-width:min(660px,90vw);font-size:clamp(9px,1.8vw,15px);color:#1a0a2e;font-style:italic;line-height:1.85;text-align:center;padding:18px 20px;background:rgba(255,255,255,.38);border-radius:8px;animation:fadeDown 1.5s ease-out .4s both;}
.final-canon{font-size:.82em;margin-top:5px;display:block;color:#3a2000;}
.restart-btn{padding:clamp(9px,1.8vh,13px) clamp(24px,5vw,44px);background:#1a0a2e;color:#ffd700;border:3px solid #ffd700;font-family:'Cinzel',serif;font-size:clamp(10px,2vw,16px);letter-spacing:3px;cursor:pointer;border-radius:4px;text-transform:uppercase;animation:fadeDown 1.5s ease-out .9s both;transition:background .2s,color .2s;}
.restart-btn:hover{background:#ffd700;color:#1a0a2e;}
</style>
</head>
<body>

<div id="loading"><div class="lc">&#10007;</div><div class="lt">Loading&hellip;</div><div id="loadingBar"><div id="loadingFill"></div></div></div>

<div id="titleScreen">
  <div class="title-stars"></div>
  <div class="title-cross">&#10007;</div>
  <div class="title-main">The Life of<br>Saint Francis<br>of Assisi</div>
  <div class="title-sub">Il Poverello &middot; 1181&ndash;1226</div>
  <div class="title-bio">
    &ldquo;Francis was not yet perfect in virtue, but he was drawing near to that perfection of the humble life which he was afterwards to lead. His heart was being stirred by the Holy Ghost, and though he knew it not, he was being prepared by the grace of God for that great work to which he had been called.&rdquo;
    <span class="title-bio-attr">&mdash; Thomas of Celano, <em>Vita Prima Sancti Francisci</em>, c.&nbsp;1228</span>
  </div>
  <button class="start-btn" id="startBtn">Begin the Journey &nbsp;&#10007;</button>
</div>

<canvas id="gameCanvas"></canvas>

<div id="cutscene">
  <div class="cut-art" id="cutArt"></div>
  <div class="cut-title" id="cutTitle"></div>
  <div class="cut-text" id="cutText"></div>
  <div class="cut-continue">[ Tap or press any key to continue ]</div>
</div>

<div id="stageBanner"></div>
<div id="objectiveBar"><div class="obj-title">Objective</div><div class="obj-text" id="objText"></div></div>
<div id="stageProgress"></div>

<div id="dialogueBox">
  <div class="dlg-speaker" id="dlgSpeaker"></div>
  <div class="dlg-text" id="dlgText"></div>
  <div class="dlg-attr" id="dlgAttr"></div>
  <div class="dlg-hint">&#9660; Tap here or press SPACE / ENTER to continue</div>
</div>

<div id="interactPrompt"></div>

<div id="joystickWrap"><div id="joystickBase"><div id="joystickKnob">&#10022;</div></div></div>

<div id="actionBtns">
  <div class="act-btn" id="btnAct"><span>&#10007;</span><span class="btn-label">PRAY</span></div>
  <div class="act-btn" id="btnNext">&#9654;</div>
</div>

<div id="miracleFlash"></div>
<div id="particleOverlay"></div>

<div id="finalScreen">
  <div class="final-title">&#10007; Pax et Bonum &#10007;<br>Peace and All Good</div>
  <div class="final-quote">
    &ldquo;Praised be You, my Lord, through Sister Bodily Death, from whom no living person can escape. Blessed are those whom death will find in Your most holy will, for the second death shall do them no harm.&rdquo;
    <span class="final-canon">&mdash; St. Francis of Assisi, <em>Canticle of the Sun</em>, 1225</span>
    <br><br>
    Francis departed this world on the evening of October&nbsp;3,&nbsp;1226, singing Psalm&nbsp;141 while lying on bare earth. He was canonised on July&nbsp;16,&nbsp;1228 by Pope Gregory&nbsp;IX &mdash; among the fastest canonisations in history. His example of poverty, humility, and love for all creation endures across every corner of the world to this day.
  </div>
  <button class="restart-btn" onclick="location.reload()">&#10007; Play Again &#10007;</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   THE LIFE OF SAINT FRANCIS OF ASSISI
   Fully corrected: joystick, all runtime bugs fixed
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const G={
  scene:null,camera:null,renderer:null,
  playerGroup:null,px:0,pz:0,
  keys:{},
  joy:{ax:0,az:0},
  gameStarted:false,stageIndex:0,
  dlgQueue:[],dlgIdx:0,dlgCb:null,dlgActive:false,
  cutCb:null,
  interactables:[],nearTarget:null,
  churchPieces:[],fixedPieces:0,totalPieces:5,
  wolfGroup:null,wolfTail:null,wolfEyes:[],wolfTamed:false,
  birds:[],birdsDone:false,stigmataDone:false,
  particles3D:[],
  frameCount:0,lastFrame:0,targetMs:1000/144,
};

/* ‚îÄ‚îÄ‚îÄ DIALOGUE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const DLG={
  assisi_welcome:[
    {s:"Narrator",t:"Assisi, Umbria ‚Äî circa 1201 AD. Giovanni di Pietro di Bernardone, called Francis, was the son of a prosperous cloth merchant. He lived a life of revelry, music, and song ‚Äî the most celebrated youth in the city.",a:"Thomas of Celano, Vita Prima Sancti Francisci, c. 1228"},
    {s:"Narrator",t:"\"He was so extravagant in his expenses that he seemed not a merchant's son but a great prince. He was eager for pleasure, full of jests and song, going about the streets of Assisi by day and night, reveling with his companions.\"",a:"Thomas of Celano, Vita Prima Sancti Francisci, Ch. I"},
    {s:"Francis",t:"Friends! Life is sweet and the night is young! Eat, drink, and sing ‚Äî for tomorrow God only knows what He has planned for us!",a:""},
    {s:"Narrator",t:"But after a battle with Perugia and a long illness, Francis returned changed ‚Äî searching. Something was calling him northward, toward the ruined chapel of San Damiano.",a:""},
  ],
  voice_of_god:[
    {s:"Narrator",t:"Francis knelt alone before the painted crucifix in the crumbling chapel of San Damiano. Damp stone, silence, candlelight. Then ‚Äî a voice, clear and unmistakable, broke the stillness.",a:""},
    {s:"Christ",t:"\"Francis... Francis... go and repair My house, which, as you see, is falling completely to ruin.\"",a:"Three Companions, Legenda Trium Sociorum, c. 1241"},
    {s:"Francis",t:"Lord... I trembled in my whole body! I did not know if You spoke of this small chapel, or of something far greater. But I will obey.",a:"Francis himself, cited in Thomas of Celano, Vita Prima"},
    {s:"Narrator",t:"Francis sold cloth from his father's warehouse to fund the work. His father Pietro was enraged. Before the bishop, Francis stripped off his fine garments and declared:",a:""},
    {s:"Francis",t:"\"Until now I have called Pietro di Bernardone my father. But now I say: Our Father, who art in heaven ‚Äî He alone is my father now.\"",a:"Thomas of Celano, Vita Prima Sancti Francisci, Ch. VI"},
  ],
  repair_intro:[
    {s:"Narrator",t:"The chapel of San Damiano lies in ruins ‚Äî crumbling upper wall, a fallen arch, a shattered window, a collapsed column, and a missing roof section.",a:""},
    {s:"Francis",t:"\"Lord, make me an instrument of Your peace. Where there is darkness, light; where there is sadness, joy.\"",a:"Prayer attributed to St. Francis of Assisi"},
    {s:"Stone Mason",t:"No man can mend these walls alone, brother. But I have seen stranger things than stone obeying the prayer of a saint.",a:""},
    {s:"Objective",t:"Walk to each of the 5 broken sections and press PRAY to repair them with prayer and labour.",a:""},
  ],
  repair_piece:[
    {s:"Francis",t:"\"Most High, glorious God, enlighten the darkness of my heart and give me true faith, certain hope, and perfect charity, sense and knowledge, Lord, that I may carry out Your holy and true command.\"",a:"St. Francis of Assisi, Prayer before the Crucifix at San Damiano"},
  ],
  repair_complete:[
    {s:"Narrator",t:"\"With his own hands he repaired three churches: San Damiano, San Pietro della Spina, and the Portiuncula. When he had fully restored them, he felt the Spirit of God driving him onward to a still greater work.\"",a:"Thomas of Celano, Vita Prima Sancti Francisci, Ch. XXI"},
    {s:"Francis",t:"The Lord has spoken to me about poverty, humility, and the holy Gospel. That is all I wish ‚Äî with all my heart!",a:"St. Francis, recorded by Thomas of Celano"},
  ],
  birds_intro:[
    {s:"Narrator",t:"Near the village of Bevagna, Francis and his companions walked along the road when Francis noticed a great flock of birds of all kinds gathered in the trees and fields nearby.",a:"Thomas of Celano, Vita Prima, Ch. LVIII"},
    {s:"Francis",t:"Brothers, wait here for me while I go preach to our sisters the birds!",a:"Thomas of Celano, Vita Prima, Ch. LVIII"},
    {s:"Companion",t:"Our sisters the birds? Francis ‚Äî they will simply fly away!",a:""},
    {s:"Francis",t:"Let us see what God has ordained. All creation belongs to Him.",a:""},
  ],
  birds_miracle:[
    {s:"Narrator",t:"Francis went to the birds, and when he began to preach, they did not fly away. They stretched their necks, spread their wings, and opened their beaks, gazing upon him with great attention.",a:"Thomas of Celano, Vita Prima, Ch. LVIII"},
    {s:"Francis",t:"\"My sisters the birds, you owe much to God your Creator, and you ought to sing His praise at all times and in all places, because He has given you liberty to fly about into all places. He has also given you a double and triple clothing.\"",a:"Thomas of Celano, Vita Prima Sancti Francisci, Ch. LVIII, c. 1228"},
    {s:"Francis",t:"\"You sow not, neither do you reap; and God feedeth you, and giveth you the streams and fountains for your drink; the mountains and valleys for your refuge. And although you neither spin nor weave, God dresseth you and your children, wherefore your Creator loveth you much.\"",a:"The Little Flowers of St. Francis, Chapter XVI, 14th century"},
    {s:"Narrator",t:"\"The birds all manifested very great joy... they began to open their beaks, to stretch their necks, to spread their wings, and reverently to bow their heads to the ground, showing by their motions and songs that the holy father had given them great delight.\"",a:"The Little Flowers of St. Francis, Ch. XVI"},
  ],
  wolf_intro:[
    {s:"Narrator",t:"Near the city of Gubbio, a fierce wolf terrorized the people ‚Äî devouring animals and men alike. The citizens dared not leave the city gates. Francis resolved to go out alone and meet the beast.",a:"The Little Flowers of St. Francis, Ch. XXI"},
    {s:"Townsman",t:"Holy brother! Do not go out! The wolf has devoured many men ‚Äî he fears nothing and no one! The whole countryside is laid waste!",a:"The Little Flowers of St. Francis, Ch. XXI, 14th century"},
    {s:"Francis",t:"Fear not, good brother. I will go to speak with Brother Wolf, in the name of Jesus Christ.",a:"St. Francis, recorded in the Fioretti"},
    {s:"Objective",t:"Go beyond the city gates and approach the wolf. Press PRAY when near him to make peace in Christ's name.",a:""},
  ],
  wolf_encounter:[
    {s:"Narrator",t:"The wolf, seeing Francis approach, ran at him with open jaws. Francis made the Sign of the Cross and called out:",a:"The Little Flowers of St. Francis, Ch. XXI"},
    {s:"Francis",t:"\"Come here, Brother Wolf. I command thee on behalf of Christ, that thou do harm neither to me nor to any other person.\"",a:"The Little Flowers of St. Francis, Chapter XXI, 14th century"},
    {s:"Narrator",t:"\"Marvellous to tell, immediately the wolf closed his mouth and stood still... and came gently as a lamb, and laid himself down at the feet of Saint Francis.\"",a:"The Little Flowers of St. Francis, Ch. XXI"},
    {s:"Francis",t:"\"Brother Wolf, I desire to make peace between you and these people. They will harm you no more, if you will promise never to harm them again. Do you give your word?\"",a:"St. Francis, recorded in the Fioretti"},
    {s:"Narrator",t:"\"The wolf bowed his head, and by the movements of his body, tail, and eyes, made signs that he consented and would keep his promise.\" Francis led him gently back into the city.",a:"The Little Flowers of St. Francis, Ch. XXI, 14th century"},
  ],
  stigmata_intro:[
    {s:"Narrator",t:"September 1224. Francis was fasting on the mountain of La Verna, forty days in honour of the Archangel Michael. On the Feast of the Holy Cross, he withdrew to pray alone in the darkness.",a:"Thomas of Celano, Vita Prima, Ch. III"},
    {s:"Francis",t:"\"My Lord Jesus Christ, before I die, I beseech Thee to grant me two graces: first, that I may feel in my soul and body that sorrow which You endured in the hour of Your most bitter Passion.\"",a:"The Little Flowers of St. Francis, Second Consideration on the Holy Stigmata"},
    {s:"Objective",t:"Ascend La Verna and approach the glowing Cross at the summit. Press PRAY to receive what God has prepared.",a:""},
  ],
  stigmata_miracle:[
    {s:"Narrator",t:"\"And suddenly there appeared in the sky a seraph with six resplendent and flaming wings; and in the middle of the vision the form of a man crucified, with hands and feet extended in the form of a cross.\"",a:"The Little Flowers of St. Francis, Second Consideration on the Holy Stigmata, 14th century"},
    {s:"Narrator",t:"\"When the vision vanished, it left in the hands, feet, and side of Francis a wonderful image and impression of the Wounds of our Lord Jesus Christ. His hands and feet seemed to be pierced through the middle with nails.\"",a:"Thomas of Celano, Vita Prima Sancti Francisci, Ch. III, ¬ß94-95, c. 1228"},
    {s:"Francis",t:"\"Welcome, Sister Pain. I have longed for you, prayed for you. Now bind me more closely to my Lord Jesus Christ.\"",a:"St. Francis, as traditionally attributed"},
    {s:"Narrator",t:"Francis received the five Stigmata ‚Äî the wounds of Christ ‚Äî becoming the first recorded person in history to bear them. He hid them under cloth, and wept with both sorrow and joy.",a:"St. Bonaventure, Major Life of St. Francis, Ch. XIII, 1263"},
  ],
  canticle_scene:[
    {s:"Narrator",t:"Ill, nearly blind, yet radiant ‚Äî Francis composed his greatest poem at San Damiano in 1225. The Canticle of the Sun was among the first works of Italian literature. Sister Clare wept as he sang.",a:""},
    {s:"Francis",t:"\"Most High, all-powerful, all-good Lord! All praise is Yours, all glory, all honour and all blessings. To You alone, Most High, do they belong. No mortal lips are worthy to pronounce Your Name.\"",a:"St. Francis of Assisi, Canticle of the Sun, 1225"},
    {s:"Francis",t:"\"Praised be You, my Lord, with all Your creatures, especially Sir Brother Sun, who is the day through whom You give us light. And he is beautiful and radiant with great splendour; of You Most High he bears the likeness.\"",a:"St. Francis of Assisi, Canticle of the Sun, 1225"},
    {s:"Francis",t:"\"Praised be You, my Lord, through Sister Moon and the stars. In the heavens You formed them, clear and precious and beautiful. Praised be You through Brother Wind, through the air, cloudy and serene, and every kind of weather.\"",a:"St. Francis of Assisi, Canticle of the Sun, 1225"},
    {s:"Francis",t:"\"Praised be You through our Sister Mother Earth, who sustains and governs us, and who produces varied fruits with coloured flowers and herbs.\"",a:"St. Francis of Assisi, Canticle of the Sun, 1225"},
    {s:"Francis",t:"\"Praised be You through those who give pardon for Your love, and bear infirmity and tribulation. Blessed are those who endure in peace, for by You, Most High, they shall be crowned.\"",a:"St. Francis of Assisi, Canticle of the Sun, 1225"},
  ],
};

/* ‚îÄ‚îÄ‚îÄ CUTSCENE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const CUTS=[
  {art:'‚õ™',title:'Stage I ‚Äî Young Francis of Assisi',
   text:'"He was a lover of music, and would often lead his companions through the streets at night singing songs. His manner was gentle, his liberality boundless, his bearing that of a prince... and yet, in the midst of all his joy, something was wanting."\n\n‚Äî Thomas of Celano, Vita Prima Sancti Francisci, c. 1228',
   key:'assisi',intro:'assisi_welcome'},
  {art:'üèó',title:'Stage II ‚Äî Rebuild My Church',
   text:'"Francis heard a voice from the crucifix saying: \'Francis, go and repair my house, which, as you see, is falling into ruins.\' At this, Francis trembled and was greatly astonished."\n\n‚Äî Three Companions, Legenda Trium Sociorum, c. 1241',
   key:'sanDamiano',intro:'repair_intro'},
  {art:'üïä',title:'Stage III ‚Äî Preach to the Birds',
   text:'"Brother Francis left his companions on the road and ran eagerly towards the birds. And when he came close to them they did not fly away, but stayed to hear his sermon. Thus is fulfilled what the prophet said: The beasts of the field shall be at peace with thee."\n\n‚Äî Thomas of Celano, Vita Prima, Ch. LVIII',
   key:'birds',intro:'birds_intro'},
  {art:'üê∫',title:'Stage IV ‚Äî The Wolf of Gubbio',
   text:'"This terrible wolf had not only devoured animals, but had attacked human beings. All the people of the town went in fear. Saint Francis, having compassion on the people, decided to go out to the wolf."\n\n‚Äî The Little Flowers of St. Francis, Ch. XXI, 14th century',
   key:'wolf',intro:'wolf_intro'},
  {art:'‚õ∞',title:'Stage V ‚Äî The Holy Stigmata',
   text:'"The marks of the nails began to appear in his hands and feet, as he had seen them a little before in the figure of the man crucified. His hands and feet seemed to be pierced through the middle with nails."\n\n‚Äî Thomas of Celano, Vita Prima Sancti Francisci, Ch. III, c. 1228',
   key:'laverna',intro:'stigmata_intro'},
  {art:'‚òÄ',title:'Finale ‚Äî The Canticle of the Sun',
   text:'"In the beginning of his conversion Francis had a great tenderness for lepers. He came upon a leper one day and, though he felt great repugnance, he mastered himself and kissed the leper\'s hand. When Francis looked back, he could see no one at all."\n\n‚Äî St. Bonaventure, Major Life of St. Francis, Ch. I, 1263',
   key:'canticle',intro:'canticle_scene'},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   THREE.JS INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initRenderer(){
  const cv=document.getElementById('gameCanvas');
  G.renderer=new THREE.WebGLRenderer({canvas:cv,antialias:false,powerPreference:'high-performance'});
  G.renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
  G.renderer.shadowMap.enabled=true;
  G.renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  G.scene=new THREE.Scene();
  G.camera=new THREE.PerspectiveCamera(68,1,0.1,300);
  doResize();
  try{new ResizeObserver(doResize).observe(document.body);}catch(e){}
  window.addEventListener('resize',doResize);
  window.addEventListener('orientationchange',()=>setTimeout(doResize,250));
}

function doResize(){
  var w=window.innerWidth,h=window.innerHeight;
  if(!w||!h||!G.renderer)return;
  G.renderer.setSize(w,h,false);
  var cv=document.getElementById('gameCanvas');
  cv.style.width=w+'px';cv.style.height=h+'px';
  if(G.camera){G.camera.aspect=w/h;G.camera.updateProjectionMatrix();}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCENE HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function tagObj(o){o.userData._stage=true;return o;}
function clearStage(){
  var rm=[];
  G.scene.traverse(function(o){if(o.userData._stage)rm.push(o);});
  for(var i=0;i<rm.length;i++)G.scene.remove(rm[i]);
  G.interactables=[];G.churchPieces=[];G.fixedPieces=0;
  G.birds=[];G.particles3D=[];
  G.wolfGroup=null;G.wolfTail=null;G.wolfEyes=[];
  G.wolfTamed=false;G.birdsDone=false;G.stigmataDone=false;
  G.nearTarget=null;
}

function sceneAdd(o){tagObj(o);G.scene.add(o);return o;}

function mkMat(col,emissiveCol,ei){
  var m=new THREE.MeshLambertMaterial({color:col});
  if(emissiveCol!=null){m.emissive=new THREE.Color(emissiveCol);m.emissiveIntensity=ei||0;}
  return m;
}
function mkBox(w,h,d,col,x,y,z){
  var m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mkMat(col));
  m.position.set(x,y,z);m.castShadow=m.receiveShadow=true;return sceneAdd(m);
}
function mkCone(r,h,s,col,x,y,z){
  var m=new THREE.Mesh(new THREE.ConeGeometry(r,h,s),mkMat(col));
  m.position.set(x,y,z);m.castShadow=true;return sceneAdd(m);
}
function mkSphere(r,ws,hs,col,x,y,z){
  var m=new THREE.Mesh(new THREE.SphereGeometry(r,ws,hs),mkMat(col));
  m.position.set(x,y,z);m.castShadow=true;return sceneAdd(m);
}
function mkGround(col,w,d){
  var m=new THREE.Mesh(new THREE.PlaneGeometry(w||90,d||90,4,4),mkMat(col));
  m.rotation.x=-Math.PI/2;m.receiveShadow=true;return sceneAdd(m);
}
function mkAmbL(col,i){return sceneAdd(new THREE.AmbientLight(col,i));}
function mkDirL(col,i,px,py,pz){
  var l=new THREE.DirectionalLight(col,i);
  l.position.set(px,py,pz);l.castShadow=true;
  l.shadow.mapSize.set(1024,1024);return sceneAdd(l);
}
function mkFog(col,n,f){G.scene.background=new THREE.Color(col);G.scene.fog=new THREE.Fog(col,n,f);}
function mkNPC(col,x,y,z){
  var g=new THREE.Group();
  var body=new THREE.Mesh(new THREE.CylinderGeometry(.3,.42,1.1,6),mkMat(col));body.position.y=.55;
  var head=new THREE.Mesh(new THREE.SphereGeometry(.27,6,5),mkMat(0xDEB887));head.position.y=1.32;
  g.add(body,head);g.position.set(x,y,z);g.castShadow=true;return sceneAdd(g);
}
function mkGlowMesh(geo,col,emCol,ei){
  var mat=new THREE.MeshLambertMaterial({color:col,emissive:new THREE.Color(emCol),emissiveIntensity:ei});
  return new THREE.Mesh(geo,mat);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function createPlayer(){
  if(G.playerGroup)G.scene.remove(G.playerGroup);
  var g=new THREE.Group();
  var body=new THREE.Mesh(new THREE.CylinderGeometry(.34,.5,1.25,6),mkMat(0x6B4226));body.position.y=.625;g.add(body);
  var head=new THREE.Mesh(new THREE.SphereGeometry(.29,6,5),mkMat(0xDEB887));head.position.y=1.55;g.add(head);
  var hood=new THREE.Mesh(new THREE.SphereGeometry(.3,6,3,0,Math.PI*2,0,Math.PI*.5),mkMat(0x5a3318));hood.position.y=1.65;g.add(hood);
  var belt=new THREE.Mesh(new THREE.TorusGeometry(.38,.045,4,8),mkMat(0xF5DEB3));belt.rotation.x=Math.PI/2;belt.position.y=.55;g.add(belt);
  var haloMat=new THREE.MeshLambertMaterial({color:0xFFD700,emissive:new THREE.Color(0xFFD700),emissiveIntensity:.6});
  var halo=new THREE.Mesh(new THREE.TorusGeometry(.38,.04,4,14),haloMat);halo.position.y=1.93;g.add(halo);
  G.playerGroup=g;
  G.scene.add(g);
  setPlayerPos(0,0);
}
function setPlayerPos(x,z){G.px=x;G.pz=z;if(G.playerGroup)G.playerGroup.position.set(x,0,z);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STAGE BUILDERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚Äî‚Äî STAGE 0: ASSISI ‚Äî‚Äî */
function buildAssisi(){
  mkFog(0x87ceeb,35,100);mkAmbL(0xfff5cc,.55);mkDirL(0xffeedd,1.2,15,30,10);mkGround(0x5a8a3a,90,90);
  for(var i=0;i<5;i++){var a=(i/5)*Math.PI*2,r=28+Math.random()*8,hh=5+Math.random()*6;mkSphere(r,6,4,0x3d7a3a,Math.cos(a)*r,hh-r+2,Math.sin(a)*r-5);}
  mkBox(8,6,6,0xd4c4a0,-12,3,-15);mkBox(8,1.5,6,0x8b3a3a,-12,7,-15);
  mkBox(6,8,5,0xd4c4a0,-5,4,-18);mkBox(6,1.5,5,0x8b3a3a,-5,8.9,-18);
  mkBox(3,12,3,0xc0b090,6,6,-16);mkBox(3,1.5,3,0x7a2020,6,13,-16);
  mkBox(10,8,2,0xd4c4a0,0,4,-22);mkBox(4,4,2,0xd4c4a0,0,10,-22);mkBox(2,2,2,0xffdd88,0,13,-22);
  mkBox(4,.1,20,0xbbaa88,0,.05,-12);
  for(var j=0;j<8;j++){var a2=(j/8)*Math.PI*2,tx=Math.cos(a2)*18,tz=Math.sin(a2)*14-5;mkBox(.6,4,.6,0x8B4513,tx,2,tz);mkCone(2.5,5,5,0x2d6b2d,tx,7,tz);}
  var comp=mkNPC(0xb06030,5,0,3);comp.userData={prompt:'Talk to Companion',dlgKey:'assisi_welcome'};
  G.interactables.push(comp);
  G.interactables.push({zone:true,x:0,z:-21,r:3.2,prompt:'Enter San Damiano Chapel',action:'dlgAdv',dlgKey:'voice_of_god'});
  setPlayerPos(0,2);setObj('Explore Assisi. Walk north to the San Damiano Chapel.');hideProgress();
}

/* ‚Äî‚Äî STAGE 1: SAN DAMIANO ‚Äî‚Äî */
function buildSanDamiano(){
  mkFog(0x7ba3cc,30,90);mkAmbL(0xfff2dd,.5);mkDirL(0xffeedd,1.1,12,28,8);mkGround(0x8B7355,80,80);
  mkBox(14,.5,10,0xbbaa80,0,.25,0);mkBox(14,4,.8,0xc8b89a,0,2,-5);mkBox(.8,6,10,0xc8b89a,-7,3,0);
  mkBox(3,1.5,1.5,0xf0e8d0,0,.75,-4.2);
  var cm=new THREE.MeshLambertMaterial({color:0xffd700,emissive:new THREE.Color(0xffd700),emissiveIntensity:.5});
  var cv=new THREE.Mesh(new THREE.BoxGeometry(.2,2,.2),cm);cv.position.set(0,2.5,-4.2);sceneAdd(cv);
  var ch=new THREE.Mesh(new THREE.BoxGeometry(.8,.2,.2),cm);ch.position.set(0,3.2,-4.2);sceneAdd(ch);
  for(var i=0;i<8;i++)mkBox(.5+Math.random(),.4,.5+Math.random(),0x998877,(Math.random()-.5)*12,.3,(Math.random()-.5)*8);
  addPiece(0xa09070,.8,3,10, 7,4.5,0, 'Upper Wall',0xd4c4a0);
  addPiece(0x998866,6,.8,.8, 0,6.2,-5,'Fallen Arch',0xc0a870);
  addPiece(0x7788aa,2.5,2.5,.3,0,4,-5,'Window',0x4488cc);
  addPiece(0x999080,.6,4,.6,-5,2,0, 'Column',0xd0c0a0);
  addPiece(0x6a4a2a,14,.4,5, 0,7,2, 'Roof Section',0x8B4513);
  setPlayerPos(0,8);setObj('Repair all 5 broken sections of San Damiano (0/5)');showProgress('Repaired: 0/5');
}

function addPiece(col,w,h,d,x,y,z,label,fixedCol){
  var m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshLambertMaterial({color:col}));
  m.position.set(x,y,z);m.rotation.z=(Math.random()-.5)*.35;m.rotation.x=(Math.random()-.5)*.12;
  m.castShadow=m.receiveShadow=true;
  m.userData={broken:true,fixedColor:fixedCol,prompt:'Repair '+label,action:'repair'};
  sceneAdd(m);G.interactables.push(m);G.churchPieces.push(m);
}

function doRepair(piece){
  if(!piece||!piece.userData||!piece.userData.broken)return;
  piece.userData.broken=false;
  piece.rotation.set(0,0,0);
  piece.material.color.setHex(piece.userData.fixedColor||0xd4c4a0);
  piece.material.emissive=new THREE.Color(0xffd700);
  piece.material.emissiveIntensity=.35;
  G.fixedPieces++;
  var idx=G.interactables.indexOf(piece);if(idx!==-1)G.interactables.splice(idx,1);
  flashMiracle(false);spawnParticles3D(piece.position,0xffd700,28);
  showDlg([DLG.repair_piece[0]]);
  var p=piece;setTimeout(function(){if(p&&p.material)p.material.emissiveIntensity=0;},2200);
  showProgress('Repaired: '+G.fixedPieces+'/'+G.totalPieces);
  setObj('Repair all 5 broken sections of San Damiano ('+G.fixedPieces+'/5)');
  if(G.fixedPieces>=G.totalPieces)setTimeout(function(){showDlg(DLG.repair_complete,advanceStage);},2800);
}

/* ‚Äî‚Äî STAGE 2: BIRDS ‚Äî‚Äî */
function buildBirds(){
  mkFog(0x5b9fd4,35,100);mkAmbL(0xfff8ee,.6);mkDirL(0xffeedd,1.3,18,32,10);mkGround(0x4a9040,90,90);
  for(var i=0;i<5;i++){var tx=(i-2)*4.5;mkBox(.5,5,.5,0x5D3A1A,tx,2.5,-15);mkCone(2.5+i*.3,6,5,0x2E8B2E,tx,9,-15);}
  for(var j=0;j<5;j++)mkSphere(7+j*3,6,4,0x3a7a3a,(j-2)*18,-4,-32);
  var fc=[0xff6688,0xffee44,0xff9944,0xee44ff,0x44aaff];
  for(var k=0;k<20;k++){var fx=(Math.random()-.5)*28,fz=(Math.random()-.5)*18-5;mkBox(.12,.7,.12,0x228822,fx,.35,fz);mkSphere(.22,4,3,fc[k%5],fx,1,fz);}
  mkBox(3,.08,22,0xbbaa80,0,.04,-10);
  var bc=[0xdd9944,0x448866,0xaa4422,0x334488,0x663322];
  for(var b=0;b<24;b++){
    var bx=(Math.random()-.5)*14-1,by=.6+Math.floor(b/8)*1.6,bz=-11+(Math.random()-.5)*5;
    var bm=new THREE.Mesh(new THREE.ConeGeometry(.22,.14,4),new THREE.MeshLambertMaterial({color:bc[b%5]}));
    bm.position.set(bx,by,bz);bm.rotation.x=Math.PI/2;
    bm.userData={origY:by,phase:Math.random()*Math.PI*2,dancing:false};
    sceneAdd(bm);G.birds.push(bm);
  }
  G.interactables.push({zone:true,x:0,z:-12,r:4.5,prompt:'Preach to the birds',action:'birds'});
  setPlayerPos(0,6);setObj('Walk north to the flock of birds and preach to them');hideProgress();
}

/* ‚Äî‚Äî STAGE 3: WOLF ‚Äî‚Äî */
function buildWolf(){
  mkFog(0x556688,25,85);mkAmbL(0xaabbcc,.5);mkDirL(0xddeeff,.9,-10,25,8);mkGround(0x4a5a40,90,90);
  for(var i=0;i<12;i++){var a=(i/12)*Math.PI*2,r=26+Math.random()*8,tx=Math.cos(a)*r,tz=Math.sin(a)*r;mkBox(.8,9+Math.random()*4,.8,0x3a2510,tx,4.5,tz);mkCone(3+Math.random()*2,9,5,0x1a4a1a,tx,12,tz);}
  mkBox(2,8,1,0xc0a880,-4,4,-18);mkBox(2,8,1,0xc0a880,4,4,-18);mkBox(10,2,1,0xc0a880,0,9,-18);
  for(var j=0;j<10;j++)mkBox(1+Math.random(),.6,1+Math.random(),0x888877,(Math.random()-.5)*20,.5,(Math.random()-.5)*14);
  buildWolfMesh();
  G.wolfGroup.position.set(0,0,-11);
  G.wolfGroup.userData.prompt='Make peace with Brother Wolf';
  G.wolfGroup.userData.action='wolf';
  G.interactables.push(G.wolfGroup);
  setPlayerPos(0,6);setObj('Find the wolf beyond the city gates and make peace');hideProgress();
}

function buildWolfMesh(){
  var g=new THREE.Group();
  var wm=new THREE.MeshLambertMaterial({color:0x556655});
  var hm=new THREE.MeshLambertMaterial({color:0x4a5a4a});
  var body=new THREE.Mesh(new THREE.BoxGeometry(1.8,1,2.4),wm.clone());body.position.y=.8;g.add(body);
  var wh=new THREE.Mesh(new THREE.BoxGeometry(.9,.8,1),hm.clone());wh.position.set(0,1.5,-1.55);g.add(wh);
  var sn=new THREE.Mesh(new THREE.BoxGeometry(.5,.4,.5),hm.clone());sn.position.set(0,1.3,-2.1);g.add(sn);
  for(var i=0;i<4;i++){var lg=new THREE.Mesh(new THREE.BoxGeometry(.3,.8,.3),wm.clone());lg.position.set(i%2===0?-.6:.6,.1,i<2?-.75:.75);g.add(lg);}
  // Tail ‚Äî stored by direct reference, NOT children[n]
  var tail=new THREE.Mesh(new THREE.BoxGeometry(.3,.3,1.1),wm.clone());
  tail.position.set(0,1.2,1.3);tail.rotation.x=-.4;g.add(tail);
  G.wolfTail=tail;
  // Eyes ‚Äî stored by direct reference, NOT children[n]
  var eyeML=new THREE.MeshLambertMaterial({color:0xff2200,emissive:new THREE.Color(0xff0000),emissiveIntensity:.9});
  var eyeMR=eyeML.clone();
  var eL=new THREE.Mesh(new THREE.SphereGeometry(.09,4,4),eyeML);eL.position.set(-.2,1.65,-1.95);g.add(eL);
  var eR=new THREE.Mesh(new THREE.SphereGeometry(.09,4,4),eyeMR);eR.position.set(.2,1.65,-1.95);g.add(eR);
  G.wolfEyes=[eL,eR];
  G.wolfGroup=g;
  sceneAdd(g);  // tags the group for clearStage removal
}

function doWolfMiracle(){
  if(G.wolfTamed)return;G.wolfTamed=true;
  var idx=G.interactables.indexOf(G.wolfGroup);if(idx!==-1)G.interactables.splice(idx,1);
  for(var i=0;i<G.wolfEyes.length;i++){
    var e=G.wolfEyes[i];
    e.material.color.setHex(0x88cc66);
    e.material.emissive.setHex(0x004400);
    e.material.emissiveIntensity=.3;
  }
  if(G.wolfGroup)G.wolfGroup.rotation.y=Math.PI;
  flashMiracle(false);spawnParticles3D(G.wolfGroup.position.clone(),0xaaffaa,45);
  showDlg(DLG.wolf_encounter,advanceStage);
}

/* ‚Äî‚Äî STAGE 4: LA VERNA ‚Äî‚Äî */
function buildLaVerna(){
  G.scene.background=new THREE.Color(0x1a2255);G.scene.fog=new THREE.Fog(0x1a2255,20,80);
  mkAmbL(0x334488,.4);mkDirL(0x8899cc,.7,-5,20,5);mkGround(0x5a4a3a,80,80);
  var rc=[0x6a5a4a,0x5a4a3a,0x4a3a2a,0x7a6a5a,0x8a7a6a];
  for(var i=0;i<5;i++){var s=5+i*3.5;var mm=new THREE.Mesh(new THREE.ConeGeometry(s,s*1.5,5),new THREE.MeshLambertMaterial({color:rc[i]}));mm.position.set((i-2)*1.5,s*.75-1,-20-i*3);sceneAdd(mm);}
  for(var j=0;j<8;j++)mkBox(3,.3,1.5,0x8a7a6a,0,j*.8,-j*2.4-2);
  var cm2=new THREE.MeshLambertMaterial({color:0xffdd88,emissive:new THREE.Color(0xffdd00),emissiveIntensity:.9});
  var vcross=new THREE.Mesh(new THREE.BoxGeometry(.28,4.5,.28),cm2);vcross.position.set(0,13,-21);sceneAdd(vcross);
  var hcross=new THREE.Mesh(new THREE.BoxGeometry(2.8,.28,.28),cm2);hcross.position.set(0,14.9,-21);sceneAdd(hcross);
  var gl=new THREE.PointLight(0xffd700,2.5,18);gl.position.set(0,15,-21);gl.userData.glow=true;sceneAdd(gl);
  var sv=[];for(var k=0;k<400;k++)sv.push((Math.random()-.5)*200,25+Math.random()*80,(Math.random()-.5)*200-30);
  var sg=new THREE.BufferGeometry();sg.setAttribute('position',new THREE.Float32BufferAttribute(sv,3));
  sceneAdd(new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:.35})));
  mkSphere(4,8,6,0xddddee,-30,40,-60);
  G.interactables.push({zone:true,x:0,z:-20,r:3.5,prompt:'Kneel before the Cross',action:'stigmata'});
  setPlayerPos(0,5);setObj('Ascend La Verna and pray before the glowing Cross');hideProgress();
}

/* ‚Äî‚Äî STAGE 5: CANTICLE ‚Äî‚Äî */
function buildCanticle(){
  G.scene.background=new THREE.Color(0xff9030);G.scene.fog=new THREE.Fog(0xff7020,25,90);
  mkAmbL(0xffddaa,.9);mkDirL(0xff8844,1.6,-25,18,8);mkGround(0x8a6a40,90,90);
  var st=0xd4c090;
  mkBox(12,8,2,st,0,4,-20);mkBox(5,4,2,st,0,10,-20);mkBox(2.5,2.5,2,0xffee88,0,13.2,-20);
  var cm3=new THREE.MeshLambertMaterial({color:0xffd700,emissive:new THREE.Color(0xffdd00),emissiveIntensity:.5});
  var vc2=new THREE.Mesh(new THREE.BoxGeometry(.2,3,.2),cm3);vc2.position.set(0,15.5,-20);sceneAdd(vc2);
  var hc2=new THREE.Mesh(new THREE.BoxGeometry(1.6,.2,.2),cm3);hc2.position.set(0,16.8,-20);sceneAdd(hc2);
  var fc2=[0xff4466,0xff8844,0xffee44,0xee44aa,0xff6688];
  for(var i=0;i<18;i++){var fx=(Math.random()-.5)*14,fz=(Math.random()-.5)*10-5;mkBox(.15,.85,.15,0x228822,fx,.42,fz);mkSphere(.3,5,4,fc2[i%5],fx,1.05,fz);}
  for(var j=0;j<4;j++){var tx=(j-1.5)*9;mkBox(.5,4.5,.5,0x5D3A1A,tx,2.25,3);mkCone(2.8,6,6,0x2d6b2d,tx,8,3);}
  for(var b=0;b<12;b++){
    var bm=new THREE.Mesh(new THREE.ConeGeometry(.28,.18,4),new THREE.MeshLambertMaterial({color:0x88aacc}));
    bm.position.set((Math.random()-.5)*20,8+Math.random()*6,(Math.random()-.5)*16);
    bm.userData={phase:Math.random()*Math.PI*2,origY:bm.position.y};
    sceneAdd(bm);G.birds.push(bm);
  }
  var sunD=new THREE.Mesh(new THREE.CircleGeometry(9,16),new THREE.MeshBasicMaterial({color:0xffcc00,side:THREE.DoubleSide}));
  sunD.position.set(-45,28,-55);sunD.rotation.y=.45;sceneAdd(sunD);
  var clare=mkNPC(0x6688cc,5,0,1);clare.userData={prompt:'Speak with Sister Clare',dlgKey:'canticle_scene'};
  G.interactables.push(clare);
  G.interactables.push({zone:true,x:0,z:-19,r:4,prompt:'Enter chapel ‚Äî sing the Canticle',action:'ending'});
  setPlayerPos(0,7);setObj('Approach the chapel and sing the Canticle of the Sun');hideProgress();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STAGE MANAGEMENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function loadStage(idx){
  G.stageIndex=idx;
  var cut=CUTS[idx];
  if(!cut){showFinal();return;}
  hideHUD();
  G.dlgActive=false;
  document.getElementById('dialogueBox').style.display='none';
  document.getElementById('interactPrompt').style.display='none';
  showCutscene(cut,function(){
    clearStage();
    createPlayer();
    if(cut.key==='assisi')buildAssisi();
    else if(cut.key==='sanDamiano')buildSanDamiano();
    else if(cut.key==='birds')buildBirds();
    else if(cut.key==='wolf')buildWolf();
    else if(cut.key==='laverna')buildLaVerna();
    else if(cut.key==='canticle')buildCanticle();
    showHUD(cut.title);
    if(cut.intro&&DLG[cut.intro])showDlg(DLG[cut.intro]);
  });
}

function advanceStage(){
  G.dlgActive=false;
  document.getElementById('dialogueBox').style.display='none';
  loadStage(G.stageIndex+1);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INTERACTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function checkNear(){
  if(!G.gameStarted)return;
  var px=G.px,pz=G.pz,best=null,bestD=Infinity;
  for(var i=0;i<G.interactables.length;i++){
    var obj=G.interactables[i];
    var ox,oz,orr;
    if(obj.isObject3D){ox=obj.position.x;oz=obj.position.z;orr=2.5;}
    else{ox=obj.x;oz=obj.z;orr=obj.r||2.5;}
    var d=Math.sqrt((px-ox)*(px-ox)+(pz-oz)*(pz-oz));
    if(d<orr+.8&&d<bestD){bestD=d;best=obj;}
  }
  G.nearTarget=best;
  var ip=document.getElementById('interactPrompt');
  if(best){
    var lbl=(best.userData&&best.userData.prompt)||best.prompt||'Interact';
    ip.textContent='‚úù PRAY ‚Äî '+lbl;ip.style.display='block';
  }else{ip.style.display='none';}
}

function handleAct(){
  if(G.dlgActive){dlgNext();return;}
  if(!G.nearTarget)return;
  var obj=G.nearTarget;
  var action=(obj.userData&&obj.userData.action)||obj.action;
  if(action==='repair'){if(obj.userData&&obj.userData.broken)doRepair(obj);return;}
  if(action==='wolf'){doWolfMiracle();return;}
  if(action==='birds'){doBirdsMiracle();return;}
  if(action==='stigmata'){doStigmata();return;}
  if(action==='dlgAdv'){
    var key=(obj.userData&&obj.userData.dlgKey)||obj.dlgKey;
    var idx=G.interactables.indexOf(obj);if(idx!==-1)G.interactables.splice(idx,1);
    if(key&&DLG[key])showDlg(DLG[key],advanceStage);else advanceStage();
    return;
  }
  if(action==='ending'){
    var idx2=G.interactables.indexOf(obj);if(idx2!==-1)G.interactables.splice(idx2,1);
    showDlg(DLG.canticle_scene,function(){setTimeout(showFinal,500);});
    return;
  }
  var dlgKey=(obj.userData&&obj.userData.dlgKey)||obj.dlgKey;
  if(dlgKey&&DLG[dlgKey]){showDlg(DLG[dlgKey]);return;}
}

function doBirdsMiracle(){
  if(G.birdsDone)return;G.birdsDone=true;
  var idx=G.interactables.findIndex(function(o){return o.action==='birds';});if(idx!==-1)G.interactables.splice(idx,1);
  flashMiracle(false);spawnParticles3D(G.playerGroup.position.clone(),0xaaffff,55);
  for(var i=0;i<G.birds.length;i++){
    (function(b){b.userData.dancing=true;setTimeout(function(){if(b.userData)b.userData.dancing=false;},5000);})(G.birds[i]);
  }
  showDlg(DLG.birds_miracle,advanceStage);
}

function doStigmata(){
  if(G.stigmataDone)return;G.stigmataDone=true;
  var idx=G.interactables.findIndex(function(o){return o.action==='stigmata';});if(idx!==-1)G.interactables.splice(idx,1);
  flashMiracle(true);
  spawnParticles3D(G.playerGroup.position.clone(),0xffffff,80);
  spawnParticles3D(G.playerGroup.position.clone(),0xffd700,60);
  showDlg(DLG.stigmata_miracle,advanceStage);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DIALOGUE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showDlg(lines,cb){
  if(!lines||!lines.length){if(cb)cb();return;}
  G.dlgQueue=lines;G.dlgIdx=0;G.dlgCb=cb||null;G.dlgActive=true;
  renderDlg();document.getElementById('dialogueBox').style.display='block';
}
function renderDlg(){
  if(G.dlgIdx>=G.dlgQueue.length){closeDlg();return;}
  var d=G.dlgQueue[G.dlgIdx];
  document.getElementById('dlgSpeaker').textContent=d.s||'';
  document.getElementById('dlgText').textContent=d.t||'';
  document.getElementById('dlgAttr').textContent=d.a||'';
}
function dlgNext(){
  if(!G.dlgActive)return;
  G.dlgIdx++;
  if(G.dlgIdx>=G.dlgQueue.length)closeDlg();else renderDlg();
}
function closeDlg(){
  G.dlgActive=false;document.getElementById('dialogueBox').style.display='none';
  var cb=G.dlgCb;G.dlgCb=null;if(cb)cb();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CUTSCENE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showCutscene(data,cb){
  G.cutCb=cb;
  document.getElementById('cutArt').textContent=data.art||'‚úù';
  document.getElementById('cutTitle').textContent=data.title||'';
  document.getElementById('cutText').textContent=data.text||'';
  document.getElementById('cutscene').style.display='flex';
}
function cutNext(){
  document.getElementById('cutscene').style.display='none';
  var cb=G.cutCb;G.cutCb=null;if(cb)cb();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EFFECTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function flashMiracle(white){
  var fl=document.getElementById('miracleFlash');
  fl.classList.remove('active','white');
  fl.getBoundingClientRect(); // force reflow
  if(white)fl.classList.add('white');
  fl.classList.add('active');
  setTimeout(function(){fl.classList.remove('active','white');},750);
}

function spawnParticles3D(pos,color,count){
  color=color||0xffd700;count=count||20;
  for(var i=0;i<count;i++){
    var m=new THREE.Mesh(
      new THREE.SphereGeometry(.07+Math.random()*.05,4,4),
      new THREE.MeshBasicMaterial({color:color,transparent:true,opacity:1})
    );
    m.position.copy(pos);
    m.userData.vel=new THREE.Vector3((Math.random()-.5)*.18,Math.random()*.18+.05,(Math.random()-.5)*.18);
    m.userData.life=1+Math.random()*.5;
    tagObj(m);G.scene.add(m);G.particles3D.push(m);
  }
}

function updateParticles(dt){
  for(var i=G.particles3D.length-1;i>=0;i--){
    var p=G.particles3D[i];
    p.userData.life-=dt*.85;
    p.position.addScaledVector(p.userData.vel,1);
    p.userData.vel.y-=.002;
    p.material.opacity=Math.max(0,p.userData.life);
    if(p.userData.life<=0){G.scene.remove(p);G.particles3D.splice(i,1);}
  }
}

setInterval(function(){
  if(!G.gameStarted)return;
  var ov=document.getElementById('particleOverlay');
  var p=document.createElement('div');p.className='cssParticle';
  var sz=2+Math.random()*4,dur=5+Math.random()*6;
  var cols=['#ffd700','#ff8c00','#fff5aa','#ffffff','#ffeebb'];
  p.style.cssText='width:'+sz+'px;height:'+sz+'px;left:'+(Math.random()*100)+'%;bottom:0;background:'+cols[Math.floor(Math.random()*5)]+';opacity:'+(0.3+Math.random()*.5)+';animation-duration:'+dur+'s;animation-delay:'+(Math.random()*2)+'s;';
  ov.appendChild(p);setTimeout(function(){if(p.parentNode)p.remove();},(dur+3)*1000);
},900);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOVEMENT + CAMERA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var SPEED=5.5,CAM_H=7.5,CAM_BACK=14;

function updateMovement(dt){
  if(G.dlgActive)return;
  var mx=G.joy.ax,mz=G.joy.az;
  var up=G.keys['ArrowUp']||G.keys['KeyW'];
  var dn=G.keys['ArrowDown']||G.keys['KeyS'];
  var lt=G.keys['ArrowLeft']||G.keys['KeyA'];
  var rt=G.keys['ArrowRight']||G.keys['KeyD'];
  if(up&&lt){mx=-.707;mz=-.707;}
  else if(up&&rt){mx=.707;mz=-.707;}
  else if(dn&&lt){mx=-.707;mz=.707;}
  else if(dn&&rt){mx=.707;mz=.707;}
  else if(up)mz=-1;else if(dn)mz=1;
  else if(lt)mx=-1;else if(rt)mx=1;
  var len=Math.sqrt(mx*mx+mz*mz);
  if(len>.01){
    var nx=mx/len,nz=mz/len;
    G.px+=nx*SPEED*dt;G.pz+=nz*SPEED*dt;
    G.playerGroup.position.x=G.px;G.playerGroup.position.z=G.pz;
    G.playerGroup.position.y=Math.abs(Math.sin(G.frameCount*.18))*.12;
    G.playerGroup.rotation.y=Math.atan2(nx,nz);
  }else{G.playerGroup.position.y=0;}
}

function updateCamera(){
  var tx=G.px,ty=CAM_H,tz=G.pz+CAM_BACK;
  G.camera.position.x+=(tx-G.camera.position.x)*.09;
  G.camera.position.y+=(ty-G.camera.position.y)*.09;
  G.camera.position.z+=(tz-G.camera.position.z)*.09;
  G.camera.lookAt(G.px,1.2,G.pz);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ENTITY ANIMATIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function animBirds(t){
  for(var i=0;i<G.birds.length;i++){
    var b=G.birds[i];if(!b.userData)continue;
    var ph=b.userData.phase||0,oy=b.userData.origY||5;
    if(b.userData.dancing){b.position.y=oy+Math.sin(t*6+ph)*.6;b.rotation.z=Math.sin(t*9+ph)*.45;}
    else{b.position.y=oy+Math.sin(t*1.4+ph)*.4;b.rotation.z=Math.sin(t*2+ph)*.18;}
  }
}
function animWolf(t){
  if(!G.wolfGroup)return;
  if(G.wolfTamed){
    if(G.wolfTail)G.wolfTail.rotation.y=Math.sin(t*8)*.4;  // direct ref ‚Äî no children[n]
    G.wolfGroup.position.y=Math.sin(t*1.5)*.05;
  }else{
    G.wolfGroup.position.y=Math.abs(Math.sin(t*2.5))*.12;
    G.wolfGroup.rotation.y=Math.sin(t*.5)*.3+Math.PI*.5;
  }
}
function animGlows(t){
  G.scene.traverse(function(o){if(o.isLight&&o.userData&&o.userData.glow)o.intensity=2+Math.sin(t*3)*.7;});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HUD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showHUD(title){
  document.getElementById('stageBanner').textContent=title;
  document.getElementById('stageBanner').style.display='block';
  document.getElementById('objectiveBar').style.display='block';
  document.getElementById('joystickWrap').style.display='block';
  document.getElementById('actionBtns').style.display='flex';
}
function hideHUD(){
  var ids=['stageBanner','objectiveBar','stageProgress','joystickWrap','actionBtns'];
  for(var i=0;i<ids.length;i++)document.getElementById(ids[i]).style.display='none';
}
function setObj(t){document.getElementById('objText').textContent=t;}
function showProgress(t){var el=document.getElementById('stageProgress');el.textContent=t;el.style.display='block';}
function hideProgress(){document.getElementById('stageProgress').style.display='none';}
function showFinal(){hideHUD();document.getElementById('dialogueBox').style.display='none';document.getElementById('finalScreen').style.display='flex';}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VIRTUAL JOYSTICK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setupJoystick(){
  var base=document.getElementById('joystickBase');
  var knob=document.getElementById('joystickKnob');
  var touchId=null;

  function maxR(){return base.offsetWidth*.38;}
  function getCenter(){var r=base.getBoundingClientRect();return{cx:r.left+r.width/2,cy:r.top+r.height/2};}

  function moveKnob(tx,ty){
    var c=getCenter(),dx=tx-c.cx,dy=ty-c.cy;
    var dist=Math.sqrt(dx*dx+dy*dy),mr=maxR();
    var clamped=Math.min(dist,mr),angle=Math.atan2(dy,dx);
    var kx=Math.cos(angle)*clamped,ky=Math.sin(angle)*clamped;
    knob.style.transform='translate(calc(-50% + '+kx+'px), calc(-50% + '+ky+'px))';
    var norm=(clamped/mr)<.08?0:(clamped/mr);
    G.joy.ax=Math.cos(angle)*norm;
    G.joy.az=Math.sin(angle)*norm;
  }
  function resetKnob(){knob.style.transform='translate(-50%,-50%)';G.joy.ax=0;G.joy.az=0;}

  base.addEventListener('touchstart',function(e){e.preventDefault();if(touchId!==null)return;var t=e.changedTouches[0];touchId=t.identifier;moveKnob(t.clientX,t.clientY);},{passive:false});
  base.addEventListener('touchmove',function(e){e.preventDefault();for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i];if(t.identifier===touchId){moveKnob(t.clientX,t.clientY);break;}}},{passive:false});
  function endT(e){for(var i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===touchId){touchId=null;resetKnob();break;}}}
  base.addEventListener('touchend',endT,{passive:false});
  base.addEventListener('touchcancel',endT,{passive:false});
  // Mouse fallback
  var md=false;
  base.addEventListener('mousedown',function(e){md=true;moveKnob(e.clientX,e.clientY);});
  document.addEventListener('mousemove',function(e){if(md)moveKnob(e.clientX,e.clientY);});
  document.addEventListener('mouseup',function(){if(md){md=false;resetKnob();}});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INPUT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setupInput(){
  document.addEventListener('keydown',function(e){
    G.keys[e.code]=true;
    if(e.code==='Space'||e.code==='Enter'){if(G.dlgActive)dlgNext();}
    if(e.code==='KeyE'||e.code==='KeyF'||e.code==='KeyX')handleAct();
    if(e.code==='Escape')cutNext();
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].indexOf(e.key)!==-1)e.preventDefault();
  });
  document.addEventListener('keyup',function(e){G.keys[e.code]=false;});

  var btnAct=document.getElementById('btnAct');
  btnAct.addEventListener('pointerdown',function(e){e.preventDefault();btnAct.classList.add('pressed');handleAct();});
  btnAct.addEventListener('pointerup',function(e){e.preventDefault();btnAct.classList.remove('pressed');});
  btnAct.addEventListener('pointercancel',function(){btnAct.classList.remove('pressed');});

  var btnNext=document.getElementById('btnNext');
  btnNext.addEventListener('pointerdown',function(e){e.preventDefault();btnNext.classList.add('pressed');if(G.dlgActive)dlgNext();});
  btnNext.addEventListener('pointerup',function(e){e.preventDefault();btnNext.classList.remove('pressed');});
  btnNext.addEventListener('pointercancel',function(){btnNext.classList.remove('pressed');});

  document.getElementById('cutscene').addEventListener('pointerup',function(e){e.stopPropagation();cutNext();});
  document.getElementById('dialogueBox').addEventListener('pointerup',function(){if(G.dlgActive)dlgNext();});
  document.getElementById('startBtn').addEventListener('pointerup',function(e){e.preventDefault();startGame();});

  setupJoystick();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN LOOP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function mainLoop(ts){
  requestAnimationFrame(mainLoop);
  var elapsed=ts-G.lastFrame;
  if(elapsed<G.targetMs)return;
  G.lastFrame=ts;
  var dt=Math.min(elapsed/1000,.05),t=ts/1000;
  G.frameCount++;
  if(G.gameStarted&&G.playerGroup&&G.scene&&G.camera){
    updateMovement(dt);updateCamera();updateParticles(dt);
    animBirds(t);animWolf(t);animGlows(t);checkNear();
  }
  if(G.renderer&&G.scene&&G.camera)G.renderer.render(G.scene,G.camera);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   START
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startGame(){
  if(G.gameStarted)return;
  G.gameStarted=true;
  document.getElementById('titleScreen').style.display='none';
  loadStage(0);
}

window.addEventListener('load',function(){
  initRenderer();
  setupInput();
  requestAnimationFrame(mainLoop);
  var fill=document.getElementById('loadingFill'),pct=0;
  var iv=setInterval(function(){
    pct=Math.min(100,pct+Math.random()*22);
    fill.style.width=pct+'%';
    if(pct>=100){clearInterval(iv);setTimeout(function(){document.getElementById('loading').style.display='none';document.getElementById('titleScreen').style.display='flex';},350);}
  },200);
});
</script>
</body>
</html>
